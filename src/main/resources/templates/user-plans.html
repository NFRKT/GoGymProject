    <!DOCTYPE html>
    <html xmlns:th="http://www.thymeleaf.org">

    <head>
        <title>Moje Plany Treningowe</title>
        <style>
        .body {
          font-family: Arial, sans-serif;
          margin: 20px;
        }

        .plan {
        display: block;
        }

        .plans-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
          gap: 20px;
        }

        .plan-panel {
          border: 1px solid #ccc;
          border-radius: 10px;
          padding: 20px;
          background-color: #f9f9f9;
          cursor: pointer;
          text-align: center;
        }

        .plan-panel h3 {
          color: #333;
        }

        /* Modal */
        .modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          justify-content: center;
          align-items: center;
        }

        .modal-content {
          background: white;
          padding: 20px;
          border-radius: 10px;
          width: 80%;
          max-height: 80%;
          overflow-y: auto;
        }

        .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-bottom: 1px solid #ddd;
          margin-bottom: 20px;
        }

        .modal-header h3 {
          margin: 0;
        }

        .close-modal {
          cursor: pointer;
          font-size: 20px;
          color: red;
        }

        .exercise {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin: 10px 0;
        }

        .exercise button {
          padding: 5px 10px;
          font-size: 14px;
        }

    .status-icon {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-circle {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: red; /* DomyÅ›lnie czerwony (nieukoÅ„czony) */
    }

    .status-icon.completed .status-circle {
      background-color: green; /* UkoÅ„czony */
    }

    .status-icon.active .status-circle {
      background-color: orange; /* Kolor dla aktywnych planÃ³w */
    }
    .plan-panel .status-container {
      margin-top: 10px;
    }

    .plan-panel .status-text {
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 5px;
      color: white;
    }

    .plan-panel .status-text:empty {
      display: none;
    }

    .plan-panel .status-text[th\\:text="'UKOÅƒCZONY'"] {
      background-color: green;
    }

    .plan-panel .status-text[th\\:text="'AKTYWNY'"] {
      background-color: orange;
    }
    .status-text {
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 5px;
      color: white;
    }

    .status-text.completed {
      background-color: green; /* TÅ‚o dla statusu UKOÅƒCZONY */
    }

    .status-text.active {
      background-color: orange; /* TÅ‚o dla statusu AKTYWNY */
    }
.loading-spinner {
    display: none;
    margin-top: 10px;
    border: 4px solid rgba(0, 0, 0, 0.1);
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}


      </style>
    </head>

    <body>
    <div>
        <input type="text" id="searchInput" placeholder="Szukaj nazwy planu..." onkeyup="filterPlans()">
        <label for="dateFilter">Data rozpoczÄ™cia:</label>
        <input type="date" id="dateFilter" onchange="filterPlans()">
        <label for="trainerSelect">Trener:</label>
        <select id="trainerSelect" onchange="filterPlans()">
            <option value="">Wszyscy trenerzy</option>
            <option th:each="trainer : ${trainers}"
                    th:value="${trainer.firstName + ' ' + trainer.secondName}"
                    th:text="${trainer.firstName + ' ' + trainer.secondName}">
            </option>
        </select>
        <select id="sortSelect" onchange="sortPlans()">
            <option value="">Sortuj wedÅ‚ug...</option>
            <option value="name">Sortuj wedÅ‚ug nazwy</option>
            <option value="startDate">Sortuj wedÅ‚ug daty rozpoczÄ™cia</option>
            <option value="status">Sortuj wedÅ‚ug statusu</option>
        </select>
        <label>
            <input type="checkbox" id="hideCompletedPlans" onchange="filterPlans()"> Ukryj ukoÅ„czone plany
        </label>
        <button onclick="resetFilters()" class="reset-button">Resetuj filtry</button>
    </div>
    <h2>Twoje Plany Treningowe</h2>
    <div class="plans-grid" th:if="${#lists.isEmpty(plans)}">
        <p>Brak dostÄ™pnych planÃ³w treningowych.</p>
    </div>
    <div class="plans-grid">
        <div class="plan-each" th:each="plan : ${plans}">
            <div class="plan-panel" th:data-plan-id="${plan.idPlan}">
                <h3 class="plan-name" th:text="${plan.name}">Nazwa Planu</h3>
                <p>
                    <strong>Opis:</strong>
                    <span th:text="${plan.description}">Opis planu...</span>
                </p>
                <p>
                    <strong>Data:</strong>
                    <span class="start-date" th:text="${plan.startDate}">Data startu</span>-
                    <span th:text="${plan.endDate}">Data koÅ„ca</span>
                </p>
                <p>
                    <strong>Trener:</strong>
                    <span class="trainer-name" th:text="${plan.trainer.firstName + ' ' + plan.trainer.secondName}">ImiÄ™ i Nazwisko</span>
                </p>
                <div class="status-container">
                    <p>
                        <strong>Status:</strong>
                        <span class="status-text"
                              th:classappend="${plan.status == T(com.GoGym.module.TrainingPlan.Status).completed ? 'completed' : 'active'}"
                              th:text="${plan.status == T(com.GoGym.module.TrainingPlan.Status).completed ? 'UKOÅƒCZONY' : 'AKTYWNY'}">
             </span>
                    </p>
                </div>
            </div>
            <!-- Modal dla szczegÃ³Å‚Ã³w planu -->
            <div class="modal" th:data-plan-id="${plan.idPlan}">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 th:text="'Plan: ' + ${plan.name}">SzczegÃ³Å‚y Planu</h3>
                        <span class="close-modal">&times;</span>
                    </div>
                    <div class="status-container">
                        <p>
                            <strong>Status planu:</strong>
                            <span id="plan-status" class="status-icon" th:classappend="${plan.status == T(com.GoGym.module.TrainingPlan.Status).completed ? 'completed' : 'active'}">
                  <span class="status-circle">
                  </span>
                </span>
                        </p>
                    </div>
                    <div th:each="day : ${plan.trainingPlanDays}">
                        <div th:data-day-id="${day.idDay}">
                            <h4>
                                <span th:text="${day.dayType == T(com.GoGym.module.TrainingPlanDay.DayType).training ? 'DzieÅ„ Treningowy' : 'Regeneracja'}"></span>
                                <span>-</span>
                                <span th:text="${#temporals.format(day.date, 'EEEE dd.MM.yyyy')}"></span>
                            </h4>
                            <div class="status-container">
                                <p>
                                    <strong>Status dnia:</strong>
                                    <span id="day-status" class="status-icon" th:classappend="${day.status == T(com.GoGym.module.TrainingPlanDay.Status).completed ? 'completed' : 'not-completed'}">
                        <span class="status-circle"></span>

                    </span>
                                    <button class="add-to-workout-btn"
                                            th:data-day-id="${day.idDay}">
                                        Sprawdzanie...
                                    </button>

                                </p>
                            </div>
                            <p>
                                <strong>Notatki:</strong>
                                <span th:text="${day.notes != null ? day.notes : 'Brak notatek'}">Brak notatek</span>
                            </p>

                            <!-- Przyciski zmiany statusu dla dni odpoczynku, tylko gdy nie ma Å¼adnych Ä‡wiczeÅ„ -->
                            <div th:if="${day.dayType == T(com.GoGym.module.TrainingPlanDay.DayType).rest and #lists.isEmpty(day.exercises)}">
                                <button class="toggle-rest-day-status" th:data-day-id="${day.idDay}"
                                        th:text="${day.status == T(com.GoGym.module.TrainingPlanDay.Status).completed ? 'Cofnij ukoÅ„czenie' : 'Oznacz jako wykonane'}"></button>
                            </div>



                            <ul>
                                <li class="exercise" th:each="exercise : ${day.exercises}">
                                    <span>
                                        <strong th:text="${exercise.exercise.name}"></strong>
                                        <span th:if="${exercise.exercise.type.name() == 'STRENGTH'}">
                                            - <span th:text="${exercise.sets}"></span> serie,
                                            <span th:text="${exercise.reps}"></span> powtÃ³rzeÅ„,
                                            <span th:text="${exercise.weight != null ? exercise.weight + ' kg' : 'bez obciÄ…Å¼enia'}"></span>
                                        </span>
                                        <span th:if="${exercise.exercise.type.name() == 'CARDIO'}">
                                            - <span class="exercise-duration"
                                                    th:data-seconds="${exercise.duration}"
                                                    th:text="${exercise.duration}"></span>,
                                            <span th:text="${exercise.distance != null ? exercise.distance + ' km' : 'Brak danych'}"></span>
                                        </span>
                                    </span>

                                    <div class="status-container">
                        <span id="exercise-status" class="status-icon" th:classappend="${exercise.status == T(com.GoGym.module.PlanExercise.Status).completed ? 'completed' : 'not-completed'}">
                            <span class="status-circle"></span>
                        </span>
                                    </div>
                                    <button class="toggle-exercise-status" th:data-exercise-id="${exercise.id}" th:text="${exercise.status.name() == 'completed' ? 'Cofnij ukoÅ„czenie' : 'Oznacz jako wykonane'}"></button>
                                    <div class="video-upload-section" th:if="${exercise.videoUrl == null}">
                                        <input type="file" class="video-input" th:data-exercise-id="${exercise.id}" accept="video/*">
                                        <button type="button" class="upload-video-btn">Dodaj film</button>

                                        <input type="text" class="video-link-input" th:data-exercise-id="${exercise.id}" placeholder="Lub wklej link do filmu">
                                        <button type="button" class="add-link-btn">Dodaj link</button>
                                    </div>
                                    <!-- ðŸ”¥ Sekcja podglÄ…du nagrania -->
                                    <div class="video-preview" th:if="${exercise.videoUrl != null}">
                                        <!-- JeÅ›li nagranie pochodzi z Cloudinary â€“ pokazujemy osadzone wideo -->
                                        <video th:if="${exercise.videoUrl.contains('cloudinary.com')}"
                                               th:src="${exercise.videoUrl}" controls width="300">
                                            Twoja przeglÄ…darka nie obsÅ‚uguje odtwarzacza wideo.
                                        </video>

                                        <!-- JeÅ›li to link YouTube lub inne ÅºrÃ³dÅ‚o â€“ pokazujemy tylko link -->
                                        <p th:if="!${exercise.videoUrl.contains('cloudinary.com')}">
                                            <a th:href="${exercise.videoUrl}" target="_blank">ðŸ”— Obejrzyj nagranie</a>
                                        </p>
                                        <button type="button" class="delete-video-btn" th:data-exercise-id="${exercise.id}">UsuÅ„ nagranie</button>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="workoutModal" class="modal" data-day-id="">
        <div class="modal-content">
            <h3>Dodaj trening</h3>
            <label>Data treningu:</label>
            <input type="date" id="workoutDate" readonly>

            <label>Godzina rozpoczÄ™cia:</label>
            <input type="time" id="startTime">

            <label>Godzina zakoÅ„czenia:</label>
            <input type="time" id="endTime">

            <label>IntensywnoÅ›Ä‡:</label>
            <select id="intensity">
                <option value="low">Niska</option>
                <option value="medium">Åšrednia</option>
                <option value="high">Wysoka</option>
            </select>

            <label>Notatki:</label>
            <textarea id="notes"></textarea>

            <h4>Ä†wiczenia:</h4>
            <div id="exerciseList"></div>

            <button id="saveWorkout">Zapisz trening</button>
            <button id="closeWorkoutModal">Anuluj</button>
        </div>
    </div>


    <script>
        function filterPlans() {
            let input = document.getElementById("searchInput").value.toLowerCase();
            let selectedDate = document.getElementById("dateFilter").value;
            let selectedTrainer = document.getElementById("trainerSelect").value.toLowerCase();
            let plans = document.querySelectorAll(".plan-each");
            let hideCompleted = document.getElementById("hideCompletedPlans").checked;
            plans.forEach(plan => {
                let planName = plan.querySelector(".plan-name").innerText.toLowerCase();
                let startDate = plan.querySelector(".start-date").innerText.trim();
                let trainerName = plan.querySelector(".trainer-name").innerText.toLowerCase();
                let statusText = plan.querySelector(".status-text").innerText.toLowerCase();
                let isCompleted = statusText.includes("ukoÅ„czony");
                let matchesSearch = planName.includes(input);
                let matchesDate = selectedDate === "" || startDate === selectedDate;
                let matchesTrainer = selectedTrainer === "" || trainerName.includes(selectedTrainer);
                if (matchesSearch && matchesDate && matchesTrainer && (!hideCompleted || !isCompleted)) {
                    plan.style.display = "block";
                } else {
                    plan.style.display = "none";
                }
            });
        }

    function sortPlans() {
        let sortBy = document.getElementById("sortSelect").value;
        let container = document.querySelector(".plans-grid");
        let plans = Array.from(document.querySelectorAll(".plan-each"));

        // Posortowanie planÃ³w
        plans.sort((a, b) => {
            if (sortBy === "name") {
                let nameA = a.querySelector(".plan-name").innerText;
                let nameB = b.querySelector(".plan-name").innerText;
                return naturalSort(nameA, nameB);
            } else if (sortBy === "startDate") {
                let dateA = new Date(a.querySelector(".start-date").innerText.trim());
                let dateB = new Date(b.querySelector(".start-date").innerText.trim());
                return dateA - dateB;
            } else if (sortBy === "status") {
                return a.querySelector(".status-text").innerText.localeCompare(b.querySelector(".status-text").innerText);
            }
        });

        // Zresetowanie zawartoÅ›ci plans-grid
        container.innerHTML = '';

        // Dodanie posortowanych elementÃ³w z powrotem do DOM
        plans.forEach(plan => container.appendChild(plan));
        }

            function naturalSort(a, b) {
            return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
        }
        let originalPlansOrder = []; // Przechowuje oryginalny ukÅ‚ad planÃ³w



        function resetFilters() {
            // Resetuj pole wyszukiwania
            document.getElementById("searchInput").value = "";
            document.getElementById("dateFilter").value = "";
            document.getElementById("sortSelect").value = "";
            document.getElementById("trainerSelect").value = "";
            document.getElementById("hideCompletedPlans").checked = false;
            let container = document.querySelector(".plans-grid");
            container.innerHTML = ""; // WyczyÅ›Ä‡ obecne plany
            originalPlansOrder.forEach(plan => container.appendChild(plan));
            let plans = document.querySelectorAll(".plan-each");
            plans.forEach(plan => plan.style.display = "block");
        }
        document.addEventListener('DOMContentLoaded', function () {
            originalPlansOrder = Array.from(document.querySelectorAll(".plan-each"));
            // Otwieranie modali
            document.querySelectorAll('.plan-panel').forEach(panel => {
                panel.addEventListener('click', () => {
                    // Sprawdza, czy klikniÄ™ty element jest przyciskiem lub linkiem
                    if (event.target.closest("button") || event.target.closest("a")) {
                        return; // JeÅ›li klikniÄ™to przycisk lub link, nie otwieramy modala
                    }
                    const planId = panel.getAttribute('data-plan-id');
                    const modal = document.querySelector(`.modal[data-plan-id="${planId}"]`);
                    modal.style.display = 'flex';
                });
            });

            // ObsÅ‚uga zamykania modali: klikniÄ™cie na X, klikniÄ™cie poza modalem, ESC
            document.addEventListener('click', (event) => {
                const modal = event.target.closest('.modal'); // Sprawdza, czy klikniÄ™to modal
                if (
                    event.target.classList.contains('close-modal') || // KlikniÄ™cie w X
                    (modal && event.target === modal) // KlikniÄ™cie poza zawartoÅ›ciÄ… modala
                ) {
                    closeModal(modal);
                }
            });

            // Zamykanie modali po naciÅ›niÄ™ciu ESC
            document.addEventListener('keydown', (event) => {
                if (event.key === "Escape") {
                    document.querySelectorAll('.modal').forEach(closeModal);
                }
            });

            function closeModal(modal) {
                if (modal) modal.style.display = 'none';
            }


            // ObsÅ‚uga klikniÄ™cia w przycisk zmiany statusu Ä‡wiczenia lub dnia odpoczynku
            document.addEventListener('click', function (event) {
                // SprawdÅº, czy klikniÄ™to przycisk zmiany statusu Ä‡wiczenia
                if (event.target.matches('.toggle-exercise-status')) {
                    const exerciseId = event.target.getAttribute('data-exercise-id');
                    const button = event.target;
                    const currentStatus = button.textContent.includes('Cofnij ukoÅ„czenie') ? false : true;

                    fetch(`/update-exercise-status/${exerciseId}?completed=${currentStatus}`, { method: 'POST' })
                        .then(response => {
                            if (!response.ok) throw new Error('Nie udaÅ‚o siÄ™ zaktualizowaÄ‡ statusu Ä‡wiczenia.');
                            return response.text();
                        })
                        .then(() => {
                            button.textContent = currentStatus ? 'Cofnij ukoÅ„czenie' : 'Oznacz jako wykonane';
                            const statusContainer = button.closest('.exercise').querySelector('.status-icon');
                            if (statusContainer) {
                                statusContainer.classList.toggle('completed', currentStatus);
                                statusContainer.classList.toggle('not-completed', !currentStatus);
                            }

                            const dayElement = button.closest('[data-day-id]');
                            if (!dayElement) {
                                console.error('Nie znaleziono elementu dnia.');
                                return;
                            }

                            const dayId = dayElement.getAttribute('data-day-id');
                            return fetch(`/update-day-status/${dayId}`, { method: 'POST' });
                        })
                        .then(response => {
                            if (!response.ok) throw new Error('Nie udaÅ‚o siÄ™ zaktualizowaÄ‡ statusu dnia.');
                            return response.json();
                        })
                        .then(data => {
                            const dayStatusElement = document.querySelector(`[data-day-id="${data.dayId}"] .status-icon`);
                            if (dayStatusElement) {
                                dayStatusElement.classList.toggle('completed', data.status === 'completed');
                                dayStatusElement.classList.toggle('not-completed', data.status !== 'completed');
                            }

                            // Aktualizacja statusu planu po kaÅ¼dej zmianie statusu dnia
                            const planId = event.target.closest('.modal').getAttribute('data-plan-id');
                            return fetch(`/update-plan-status/${planId}`, { method: 'POST' });
                        })
                        .then(response => {
                            if (!response.ok) throw new Error('Nie udaÅ‚o siÄ™ zaktualizowaÄ‡ statusu planu.');
                            return response.json();
                        })
                        .then(data => {
                            const planStatusElement = document.querySelector(`.modal[data-plan-id="${data.planId}"] #plan-status`);
                            if (planStatusElement) {
                                planStatusElement.classList.toggle('completed', data.status === 'completed');
                                planStatusElement.classList.toggle('active', data.status !== 'completed');
                            }

                            const planId = data.planId;

                            // Aktualizacja statusu na kafelku planu
                            const planPanel = document.querySelector(`.plan-panel[data-plan-id="${planId}"] .status-text`);
                            if (planPanel) {
                                const isCompleted = data.status === 'completed';
                                planPanel.textContent = isCompleted ? 'UKOÅƒCZONY' : 'AKTYWNY';
                                planPanel.classList.remove('completed', 'active');
                                planPanel.classList.add(isCompleted ? 'completed' : 'active');
                                planPanel.style.backgroundColor = data.status === 'completed' ? 'green' : 'orange';
                            }
                        })
                        .catch(error => console.error('BÅ‚Ä…d:', error));
                }

                // SprawdÅº, czy klikniÄ™to przycisk zmiany statusu dnia odpoczynku
    // ObsÅ‚uga klikniÄ™cia w przycisk zmiany statusu dnia odpoczynku
    if (event.target.matches('.toggle-rest-day-status')) {
        const dayId = event.target.getAttribute('data-day-id');
        const button = event.target;
        const currentStatus = button.textContent.includes('Cofnij ukoÅ„czenie') ? false : true;

        fetch(`/update-rest-day-status/${dayId}`, { method: 'POST' })
            .then(response => {
                if (!response.ok) throw new Error('Nie udaÅ‚o siÄ™ zaktualizowaÄ‡ statusu dnia odpoczynku.');
                return response.json();
            })
            .then(data => {
                // Aktualizacja tekstu przycisku
                button.textContent = currentStatus ? 'Cofnij ukoÅ„czenie' : 'Oznacz jako wykonane';

                // Znalezienie kontenera statusu dla dnia regeneracyjnego
                const dayElement = document.querySelector(`[data-day-id="${data.dayId}"]`);
                if (!dayElement) {
                    console.error(`Nie znaleziono elementu dnia o ID: ${data.dayId}`);
                    return;
                }

                const statusContainer = dayElement.querySelector('.status-icon');
                if (statusContainer) {
                    // Zmiana klasy statusu
                    statusContainer.classList.toggle('completed', currentStatus);
                    statusContainer.classList.toggle('not-completed', !currentStatus);
                }

                // Aktualizacja statusu planu
                const planId = button.closest('.modal').getAttribute('data-plan-id');
                return fetch(`/update-plan-status/${planId}`, { method: 'POST' });
            })
            .then(response => {
                if (!response.ok) throw new Error('Nie udaÅ‚o siÄ™ zaktualizowaÄ‡ statusu planu.');
                return response.json();
            })
            .then(data => {
                // Aktualizacja statusu planu w modal i na kafelku
                const planStatusElement = document.querySelector(`.modal[data-plan-id="${data.planId}"] #plan-status`);
                if (planStatusElement) {
                    planStatusElement.classList.toggle('completed', data.status === 'completed');
                    planStatusElement.classList.toggle('active', data.status !== 'completed');
                }

                const planPanel = document.querySelector(`.plan-panel[data-plan-id="${data.planId}"] .status-text`);
                if (planPanel) {
                    const isCompleted = data.status === 'completed';
                    planPanel.textContent = isCompleted ? 'UKOÅƒCZONY' : 'AKTYWNY';
                    planPanel.classList.remove('completed', 'active');
                    planPanel.classList.add(isCompleted ? 'completed' : 'active');
                    planPanel.style.backgroundColor = isCompleted ? 'green' : 'orange';
                }
            })
            .catch(error => console.error('BÅ‚Ä…d:', error));
    }

            });
        });
            function formatDuration(seconds) {
            if (isNaN(seconds) || seconds === null) return "Brak danych";
            let hours = Math.floor(seconds / 3600);
            let minutes = Math.floor((seconds % 3600) / 60);
            let remainingSeconds = seconds % 60;
            return hours > 0
                ? `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`
                : `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".exercise-duration").forEach(el => {
                let seconds = parseInt(el.getAttribute("data-seconds"), 10);
                el.textContent = formatDuration(seconds);
            });
        });


document.addEventListener("DOMContentLoaded", function () {
    function attachUploadEvents() {
        document.querySelectorAll(".upload-video-btn").forEach(button => {
            button.onclick = function () {
                let exerciseId = this.previousElementSibling.getAttribute("data-exercise-id");
                let fileInput = this.previousElementSibling;
                let file = fileInput.files[0];

                if (!file) {
                    alert("ProszÄ™ wybraÄ‡ plik wideo.");
                    return;
                }

                if (file.size > 100 * 1024 * 1024) { // 100MB limit
                    alert("Plik jest za duÅ¼y! Maksymalny rozmiar to 100MB. MoÅ¼esz dodaÄ‡ link do wideo zamiast przesyÅ‚aÄ‡ plik.");
                    return;
                }

                showLoadingSpinner(exerciseId);

                let formData = new FormData();
                formData.append("file", file);

                fetch(`/video/upload/${exerciseId}`, { method: "POST", body: formData })
                    .then(response => response.text())
                    .then(videoUrl => {
                        replaceWithVideo(exerciseId, videoUrl, "cloudinary");
                    })
                    .catch(error => console.error("BÅ‚Ä…d:", error))
                    .finally(() => setTimeout(() => hideLoadingSpinner(exerciseId), 50)); // ðŸ”„ Dodane opÃ³Åºnienie
            };
        });

        document.querySelectorAll(".add-link-btn").forEach(button => {
            button.onclick = function () {
                let exerciseId = this.previousElementSibling.getAttribute("data-exercise-id");
                let linkInput = this.previousElementSibling;
                let link = linkInput.value.trim();

                if (!link) {
                    alert("ProszÄ™ wpisaÄ‡ link do wideo.");
                    return;
                }

                showLoadingSpinner(exerciseId);

                fetch(`/video/link/${exerciseId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: "link=" + encodeURIComponent(link)
                })
                .then(response => response.text())
                .then(videoUrl => {
                    replaceWithVideo(exerciseId, videoUrl, "link");
                })
                .catch(error => console.error("BÅ‚Ä…d:", error))
                .finally(() => setTimeout(() => hideLoadingSpinner(exerciseId), 50));
            };
        });
    }

    function attachDeleteEvents() {
        document.querySelectorAll(".delete-video-btn").forEach(button => {
            button.onclick = function () {
                let exerciseId = this.getAttribute("data-exercise-id");

                showLoadingSpinner(exerciseId);

                fetch(`/video/delete/${exerciseId}`, { method: "DELETE" })
                    .then(response => response.text())
                    .then(() => {
                        restoreUploadSection(exerciseId);
                    })
                    .catch(error => console.error("BÅ‚Ä…d:", error))
                    .finally(() => setTimeout(() => hideLoadingSpinner(exerciseId), 50));
            };
        });
    }

    function replaceWithVideo(exerciseId, videoUrl, type) {
        let exerciseElement = document.querySelector(`.exercise [data-exercise-id="${exerciseId}"]`).closest(".exercise");

        let videoSection = exerciseElement.querySelector(".video-upload-section");
        if (videoSection) {
            videoSection.remove();
        }

        let oldVideoStatus = exerciseElement.querySelector(".video-preview");
        if (oldVideoStatus) {
            oldVideoStatus.remove();
        }

        let videoStatusDiv = document.createElement("div");
        videoStatusDiv.classList.add("video-preview");
        if (type === "cloudinary") {
            // **Dla nagrania Cloudinary â€“ osadzamy wideo**
            videoStatusDiv.innerHTML = `
                <video src="${videoUrl}" controls width="300">
                    Twoja przeglÄ…darka nie obsÅ‚uguje odtwarzacza wideo.
                </video>
                <button type="button" class="delete-video-btn" data-exercise-id="${exerciseId}">UsuÅ„ nagranie</button>
            `;
        } else {
            // **Dla linkÃ³w YouTube â€“ tylko klikalny link**
            videoStatusDiv.innerHTML = `
                <p><a href="${videoUrl}" target="_blank">ðŸ”— Obejrzyj nagranie</a></p>
                <button type="button" class="delete-video-btn" data-exercise-id="${exerciseId}">UsuÅ„ nagranie</button>
            `;
        }
        exerciseElement.appendChild(videoStatusDiv);

        attachDeleteEvents();
    }

    function restoreUploadSection(exerciseId) {
        let exerciseElement = document.querySelector(`.exercise [data-exercise-id="${exerciseId}"]`).closest(".exercise");

        let oldVideoStatus = exerciseElement.querySelector(".video-preview");
        if (oldVideoStatus) {
            oldVideoStatus.remove();
        }

        let videoUploadHtml = `
            <div class="video-upload-section">
                <input type="file" class="video-input" data-exercise-id="${exerciseId}" accept="video/*">
                <button type="button" class="upload-video-btn">Dodaj film</button>

                <input type="text" class="video-link-input" data-exercise-id="${exerciseId}" placeholder="Lub wklej link do filmu">
                <button type="button" class="add-link-btn">Dodaj link</button>
            </div>
            <div class="loading-spinner" id="spinner-${exerciseId}"></div>
        `;
        exerciseElement.insertAdjacentHTML("beforeend", videoUploadHtml);

        attachUploadEvents();
    }

    function showLoadingSpinner(exerciseId) {
        let exerciseElement = document.querySelector(`.exercise [data-exercise-id="${exerciseId}"]`).closest(".exercise");

        let spinner = exerciseElement.querySelector(".loading-spinner");
        if (!spinner) {
            spinner = document.createElement("div");
            spinner.classList.add("loading-spinner");
            spinner.setAttribute("id", `spinner-${exerciseId}`);
            exerciseElement.appendChild(spinner);
        }
        spinner.style.display = "block";
    }

    function hideLoadingSpinner(exerciseId) {
        let spinner = document.getElementById(`spinner-${exerciseId}`);
        if (spinner) {
            spinner.style.display = "none";
            spinner.remove(); // ðŸ”¥ Dodatkowo usuwamy element, Å¼eby uniknÄ…Ä‡ zduplikowania
        }
    }

    attachUploadEvents();
    attachDeleteEvents();
});

document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".add-to-workout-btn").forEach(button => {
        const dayId = button.getAttribute("data-day-id");

        // Sprawdzenie, czy workout istnieje dla tego dnia i ustawienie tekstu przycisku
        fetch(`/workouts/check-workout-exists/${dayId}`)
            .then(response => response.json())
            .then(exists => {
                button.textContent = exists ? "UsuÅ„ dzieÅ„ z workoutÃ³w" : "Dodaj dzieÅ„ do workoutÃ³w";
            })
            .catch(error => {
                console.error("BÅ‚Ä…d sprawdzania workoutu:", error);
                button.textContent = "Dodaj dzieÅ„ do workoutÃ³w"; // DomyÅ›lna wartoÅ›Ä‡
            });

        // ObsÅ‚uga klikniÄ™cia w przycisk "Dodaj/UsuÅ„ dzieÅ„ do workoutÃ³w"
        button.addEventListener("click", function () {
            const isRemoving = this.textContent.includes("UsuÅ„");

            if (isRemoving) {
                // Usuwanie workoutu
                fetch(`/workouts/remove-workout-from-day?dayId=${dayId}`, { method: "POST" })
                    .then(response => {
                        if (!response.ok) throw new Error("BÅ‚Ä…d usuwania workoutu");
                        return response.text();
                    })
                    .then(() => {
                        alert("Workout zostaÅ‚ usuniÄ™ty!");
                        this.textContent = "Dodaj dzieÅ„ do workoutÃ³w";
                    })
                    .catch(error => console.error("BÅ‚Ä…d:", error));
            } else {
                // Pobranie danych treningowego dnia i otwarcie modala
                fetch(`/get-training-day/${dayId}`)
                    .then(response => response.json())
                    .then(day => {
                        document.getElementById("workoutModal").setAttribute("data-day-id", dayId);
                        document.getElementById("workoutDate").value = day.date;
                        document.getElementById("exerciseList").innerHTML = "";

                        // Filtrowanie Ä‡wiczeÅ„, aby dodaÄ‡ tylko ukoÅ„czone
                        const completedExercises = day.exercises.filter(exercise => exercise.status === "completed");

                        if (completedExercises.length === 0) {
                            alert("Nie masz ukoÅ„czonych Ä‡wiczeÅ„ w tym dniu!");
                            return;
                        }

                        completedExercises.forEach(exercise => {
                            let exerciseRow = document.createElement("div");
                            exerciseRow.innerHTML = `
                                <p><strong>${exercise.exercise?.name || "Nieznane Ä‡wiczenie"}</strong> -
                                ${exercise.sets ? `${exercise.sets}x${exercise.reps}, ${exercise.weight ?? "bez obciÄ…Å¼enia"} kg` :
                                `${exercise.duration} min, ${exercise.distance ?? "Brak dystansu"} km`}</p>`;
                            document.getElementById("exerciseList").appendChild(exerciseRow);
                        });

                        document.getElementById("workoutModal").style.display = "flex";
                    })
                    .catch(error => console.error("BÅ‚Ä…d podczas pobierania dnia treningowego:", error));
            }
        });
    });

    // ObsÅ‚uga zapisu workoutu z modala
    document.getElementById("saveWorkout").addEventListener("click", function () {
        const startTime = document.getElementById("startTime").value;
        const endTime = document.getElementById("endTime").value;
        const intensity = document.getElementById("intensity").value;
        const notes = document.getElementById("notes").value;
        const dayId = document.getElementById("workoutModal").getAttribute("data-day-id");

        if (!startTime || !endTime) {
            alert("Musisz podaÄ‡ godzinÄ™ rozpoczÄ™cia i zakoÅ„czenia treningu!");
            return;
        }

        const workoutData = {
            dayId: dayId,
            startTime: startTime,
            endTime: endTime,
            intensity: intensity,
            notes: notes
        };

        fetch("/workouts/add-workout-from-day", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(workoutData)
        })
        .then(response => {
            if (!response.ok) throw new Error("BÅ‚Ä…d dodawania workoutu");
            return response.text();
        })
        .then(() => {
            alert("Workout zostaÅ‚ dodany!");
            document.getElementById("workoutModal").style.display = "none";

            // Zmiana przycisku na "UsuÅ„ dzieÅ„ z workoutÃ³w"
            document.querySelector(`.add-to-workout-btn[data-day-id="${dayId}"]`).textContent = "UsuÅ„ dzieÅ„ z workoutÃ³w";
        })
        .catch(error => console.error("BÅ‚Ä…d:", error));

        resetWorkoutModal();
    });

    function resetWorkoutModal() {
        document.getElementById("workoutModal").removeAttribute("data-day-id");
        document.getElementById("workoutDate").value = "";
        document.getElementById("startTime").value = "";
        document.getElementById("endTime").value = "";
        document.getElementById("intensity").value = "medium";
        document.getElementById("notes").value = "";
        document.getElementById("exerciseList").innerHTML = "";
        document.getElementById("workoutModal").style.display = "none";
    }
});
    </script>
    </body>
    </html>