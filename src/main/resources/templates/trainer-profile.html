<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Profil Trenera - Panel Admina</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Wspólne style -->
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato|Montserrat">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
      html, body {
        height: 100%;
        margin: 0;
        background-color: #292d35;
        font-family: "Lato", sans-serif;
        display: flex;
        flex-direction: column;
      }
      .container {
        position: relative;
        max-width: 800px;
        width: 94%;
        margin: 40px auto;
        padding: 30px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        flex: 1;
      }
      .btn-back {
        position: absolute;
        top: 20px;
        left: 20px;
        background: #303a53;
        color: white;
        padding: 8px 12px;
        border-radius: 5px;
        text-decoration: none;
        font-size: 14px;
        z-index: 10;
        cursor: pointer;
      }
      h2 {
        text-align: center;
        margin-top: 40px;
        margin-bottom: 20px;
        color: #303a53;
      }
      .section {
        margin-bottom: 30px;
      }
      .section h3 {
        color: #303a53;
        margin-bottom: 15px;
        border-bottom: 1px solid #ccc;
        padding-bottom: 5px;
      }
      .profile-pic {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid #303a53;
        display: block;
        margin: 0 auto;
      }
      .info {
        margin-top: 20px;
        text-align: center;
      }
      .info p {
        margin: 5px 0;
      }
      .btn {
        background: #303a53;
        color: white;
        padding: 8px 12px;
        border: none;
        border-radius: 5px;
        text-decoration: none;
        cursor: pointer;
        font-size: 14px;
        margin: 5px;
      }
        .btn-back {
        background: #303a53;
        color: white;
        padding: 8px 12px;
        border-radius: 5px;
        text-decoration: none;
        font-size: 14px;
      }
      .btn-edit, .btn-delete {
        margin: 5px;
      }
      .table-container {
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        min-width: 500px;
      }
      th, td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
      /* Responsywność */
      @media screen and (max-width: 768px) {
        .container {
          margin: 20px;
          padding: 15px;
        }
        h2 {
          font-size: 1.6em;
        }
        .btn-back, .btn {
          font-size: 12px;
          padding: 6px 10px;
        }
        table, th, td {
          font-size: 12px;
        }
      }
      /* Formularz edycji */
      .edit-experience-form {
          margin-top: 15px;
          padding: 15px;
          background: #f9f9f9;
          border-radius: 8px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      /* Podgląd nowego certyfikatu */
      .cert-preview-container {
          margin-top: 10px;
          text-align: center;
      }
      .cert-preview {
          max-width: 100px;
          max-height: 100px;
          object-fit: cover;
          border: 2px solid #ccc;
          border-radius: 8px;
          display: block;
          margin: 5px auto;
      }
      /* Kontener na certyfikaty */
      .certificates-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 15px;
          list-style: none;
          padding: 0;
          text-align: center;
      }
      /* Pojedynczy certyfikat */
      .certificate-container {
          text-align: center;
          position: relative;
      }
      /* Obrazy certyfikatów */
      .experience-cert {
          width: 150px;
          height: 150px;
          object-fit: cover;
          border-radius: 8px;
          border: 2px solid #ccc;
          cursor: pointer;
          transition: transform 0.3s ease;
      }
      /* Hover efekt dla obrazów */
      .experience-cert:hover {
          transform: scale(1.05);
      }
      /* PDF link */
      .certificate-pdf {
          display: block;
          text-align: center;
          font-weight: bold;
          color: #303a53;
          text-decoration: none;
          padding: 5px;
          border-radius: 5px;
          border: 1px solid #303a53;
          transition: background 0.3s ease;
      }
      .certificate-pdf:hover {
          background: #303a53;
          color: white;
      }
      /* Lightbox – Powiększanie zdjęć */
      .lightbox {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          justify-content: center;
          align-items: center;
          z-index: 9999;
      }
      .lightbox-content {
          max-width: 90%;
          max-height: 90%;
          border-radius: 8px;
      }
      /* Styl dla błędnych pól */
      .input-error {
          border: 2px solid red !important;
          background-color: #ffe6e6;
      }
      /* Komunikaty błędów */
      .error-message {
          color: red;
          font-size: 12px;
          margin-top: 5px;
      }
          .img-preview-container {
      position: relative;
      display: none;
      width: 200px;
      margin-top: 10px;
    }
    .img-preview {
      width: 100%;
      border: 2px solid #ccc;
      border-radius: 5px;
    }
    .remove-img-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    textarea {
      resize: none;
    }
    </style>
</head>
<body>

<div th:replace="~{header :: header}"></div>

<div class="container">
    <button class="btn-back" onclick="goBack()">Powrót</button>
    <h2>Profil Trenera</h2>
    <!-- Sekcja zdjęcia profilowego -->
    <div class="section">
        <div style="text-align: center;">
            <img th:if="${trainerDetails?.profilePicture != null}" th:src="@{'/uploads/avatars/' + ${trainerDetails.profilePicture}}" class="profile-pic" alt="Zdjęcie Profilowe"/>
            <img th:if="${trainerDetails?.profilePicture == null}" th:src="@{'/images/default-profile.png'}" class="profile-pic" alt="Zdjęcie Profilowe"/>
        </div>
        <div style="text-align: center; margin-top: 10px;" th:if="${isOwnProfile}">
            <form id="uploadProfilePictureForm" enctype="multipart/form-data">
                <input type="file" name="profilePicture" required/>
                <button type="button" class="btn" onclick="uploadProfilePicture()">Zmień zdjęcie</button>
            </form>
            <button type="button" class="btn btn-delete" onclick="deleteProfilePicture()">Usuń zdjęcie</button>
        </div>
    </div>
    <!-- Sekcja informacji osobistych -->
    <div class="section">
        <h3>Informacje Osobiste</h3>
        <div class="info">
            <p>
                <strong>Imię i nazwisko:</strong>
                <span id="nameText" th:text="${user.firstName + ' ' + user.lastName}">Imię Nazwisko</span>
            </p>
            <p>
                <strong>Data urodzenia:</strong>
                <span id="birthDateText" th:text="${user.birthDate != null ? #dates.format(user.birthDate, 'yyyy-MM-dd') : 'Nie podano'}">Data urodzenia</span>
            </p>
            <p>
                <strong>Płeć:</strong>
                <span id="genderText" th:text="${user.gender != null ? user.gender : 'Nie podano'}">Płeć</span>
            </p>
        </div>
    </div>

    <!-- Sekcja opinii i ocen -->
    <div class="section">
        <h3>Opinie i Oceny</h3>
        <div class="info">
            <p><strong>Średnia ocena:</strong> <span id="averageRating">Brak ocen</span> ⭐</p>
        </div>
        <div th:if="${!isOwnProfile}">
            <form id="reviewForm">
                <label>Ocena:</label>
                <select name="rating">
                    <option value="5">⭐⭐⭐⭐⭐</option>
                    <option value="4">⭐⭐⭐⭐</option>
                    <option value="3">⭐⭐⭐</option>
                    <option value="2">⭐⭐</option>
                    <option value="1">⭐</option>
                </select>
                <label>Komentarz:</label>
                <textarea name="comment" rows="3" class="w3-input w3-border"></textarea>
                <button type="submit" class="btn">Dodaj opinię</button>
            </form>
        </div>
        <div id="userReviewContainer" style="display: none;">
            <h4>Twoja opinia</h4>
            <ul id="userReviewList"></ul>
        </div>
        <div id="editReviewForm" style="display: none;">
            <h4>Edytuj swoją opinię</h4>
            <label>Ocena:</label>
            <select id="editRating">
                <option value="5">⭐⭐⭐⭐⭐</option>
                <option value="4">⭐⭐⭐⭐</option>
                <option value="3">⭐⭐⭐</option>
                <option value="2">⭐⭐</option>
                <option value="1">⭐</option>
            </select>
            <label>Komentarz:</label>
            <textarea id="editComment" rows="3" class="w3-input w3-border"></textarea>
            <button class="btn" onclick="saveEditedReview()">Zapisz zmiany</button>
            <button class="btn" onclick="cancelEdit()">Anuluj</button>
        </div>
        <h4>Opinie</h4>
        <ul id="reviewList"></ul>
        <div style="text-align: center;">
            <button id="prevPage" class="btn" onclick="changePage(-1)" disabled>Poprzednia</button>
            <span id="currentPage">1</span>
            <button id="nextPage" class="btn" onclick="changePage(1)">Następna</button>
        </div>
    </div>

    <!-- Sekcja informacji zawodowych -->
    <div class="section">
        <h3>Informacje Zawodowe</h3>
        <div class="info">
            <p><strong>Data rozpoczęcia kariery:</strong>
                <span id="startDateText" th:text="${trainerDetails?.startDate != null ? #dates.format(trainerDetails.startDate, 'yyyy-MM-dd') : 'Nie podano'}">Data</span>
                <button class="btn btn-edit" onclick="toggleEdit('editStartDate', 'startDateInput', 'startDateText')" th:if="${isOwnProfile}">Edytuj</button>
            </p>
            <form id="editStartDate" style="display:none;">
                <input type="date" id="startDateInput" class="w3-input w3-border"/>
                <button type="submit" class="btn">Zapisz</button>
            </form>
            <p><strong>Numer telefonu:</strong>
                <span id="phoneNumberText" th:text="${trainerDetails?.phoneNumber != null ? trainerDetails.phoneNumber : 'Nie podano'}">Telefon</span>
                <button class="btn btn-edit" onclick="toggleEdit('editPhoneNumber', 'phoneNumberInput', 'phoneNumberText')" th:if="${isOwnProfile}">Edytuj</button>
            </p>
            <form id="editPhoneNumber" style="display:none;">
                <input type="text" id="phoneNumberInput" class="w3-input w3-border"/>
                <button type="submit" class="btn">Zapisz</button>
            </form>
            <p><strong>Obszar pracy:</strong>
                <span id="workAreaText" th:text="${trainerDetails?.workArea != null ? trainerDetails.workArea : 'Nie podano'}">Obszar</span>
                <button class="btn btn-edit" onclick="toggleEdit('editWorkArea', 'workAreaInput', 'workAreaText')" th:if="${isOwnProfile}">Edytuj</button>
            </p>
            <form id="editWorkArea" style="display:none;">
                <input type="text" id="workAreaInput" class="w3-input w3-border"/>
                <button type="submit" class="btn">Zapisz</button>
            </form>
        </div>
    </div>

    <!-- Sekcja Bio -->
    <div class="section">
        <h3>Bio</h3>
        <div class="info">
            <p><strong>Opis:</strong>
                <span id="bioText" th:text="${trainerDetails?.bio != null ? trainerDetails.bio : 'Nie podano'}">Opis</span>
                <button class="btn btn-edit" onclick="toggleEdit('editBioForm', 'bioInput', 'bioText')" th:if="${isOwnProfile}">Edytuj</button>
            </p>
            <form id="editBioForm" style="display:none;">
                <textarea id="bioInput" name="bio" class="w3-input w3-border" rows="4"></textarea>
                <button type="submit" class="btn">Zapisz</button>
            </form>
        </div>
    </div>

    <!-- Sekcja Specjalizacji -->
    <div class="section">
        <h3>Specjalizacje</h3>
        <ul id="specializationList">
            <li th:each="specialization : ${specializations}" th:attr="data-specialization-id=${specialization.id}">
                <span class="specialization-name" th:text="${specialization.specialization}">Specjalizacja</span>
                <button class="btn btn-edit" onclick="toggleEditSpecialization(this)" th:if="${isOwnProfile}">Edytuj</button>
                <button class="btn btn-delete" th:attr="onclick='deleteSpecialization(' + ${specialization.id} + ', this)'" th:if="${isOwnProfile}">Usuń</button>
                <!-- Formularz edycji specjalizacji -->
                <form class="edit-specialization-form" style="display:none; margin-top:10px;">
                    <input type="hidden" name="specializationId" th:value="${specialization.id}">
                    <input type="text" name="specialization" class="w3-input w3-border" th:value="${specialization.specialization}" required/>
                    <button type="submit" class="btn">Zapisz</button>
                    <button type="button" onclick="toggleEditSpecialization(this)" class="btn">Anuluj</button>
                </form>
            </li>
        </ul>
        <form id="specializationForm" th:if="${isOwnProfile}">
            <h4>Dodaj nową specjalizację</h4>
            <input type="text" name="specialization" placeholder="Nowa specjalizacja" required class="w3-input w3-border"/>
            <button type="submit" class="btn">Dodaj</button>
        </form>
    </div>

    <!-- Sekcja Doświadczenia i Certyfikatów -->
    <div class="section">
        <h3>Doświadczenie i Certyfikaty</h3>
        <ul id="experienceList" class="certificates-grid">
            <li th:each="experience : ${experiences}" th:attr="data-experience-id=${experience.id}">
                <span class="experience-name" th:text="${experience.graduationName}">Nazwa</span>
                (Data: <span class="experience-date" th:text="${experience.graduationDate != null ? #dates.format(experience.graduationDate, 'yyyy-MM-dd') : 'Nie podano'}">Data</span>)
                <div th:if="${experience.certificationFile}" class="certificate-container">
                <span th:if="${#strings.endsWith(experience.certificationFile, '.pdf')}">
                    <a th:href="@{'/uploads/certifications/' + ${experience.certificationFile}}" target="_blank" class="certificate-pdf">
                        Otwórz certyfikat (PDF)
                    </a>
                </span>
                    <span th:if="${!#strings.endsWith(experience.certificationFile, '.pdf')}">
                    <img th:src="@{'/uploads/certifications/' + ${experience.certificationFile}}"
                         class="experience-cert"
                         alt="Certyfikat"
                         onclick="openLightbox(this)" />
                </span>
                </div>
                <button class="btn btn-edit" onclick="toggleEditExperience(this)" th:if="${isOwnProfile}">Edytuj</button>
                <button class="btn btn-delete" th:attr="onclick='deleteExperience(' + ${experience.id} + ', this)'" th:if="${isOwnProfile}">Usuń</button>
                <!-- Formularz edycji doświadczenia -->
                <form class="edit-experience-form" style="display:none; margin-top:10px;">
                    <input type="hidden" name="experienceId" th:value="${experience.id}">

                    <label>Nazwa kursu/szkoły:</label>
                    <input type="text" name="graduationName" class="w3-input w3-border" th:value="${experience.graduationName}"/>

                    <label>Data uzyskania certyfikatu:</label>
                    <input type="date" name="graduationDate" class="w3-input w3-border"
                           th:value="${experience.graduationDate != null ? #dates.format(experience.graduationDate, 'yyyy-MM-dd') : ''}"/>

                    <label>Nowy plik certyfikatu (opcjonalnie):</label>
                    <input type="file" class="w3-input w3-border certificationFileInput" accept="image/*,.pdf"
                           onchange="previewNewCertificate(event, this)"/>

                    <!-- Podgląd nowego certyfikatu -->
                    <div class="img-preview-container" id="imgPreviewContainerEdit">
                        <img class="img-preview" id="imgPreviewEdit" alt="Podgląd pliku"/>
                        <button type="button" class="remove-img-btn" onclick="removeSelectedFile()">✖</button>
                    </div>

                    <button type="submit" class="btn">Zapisz</button>
                    <button type="button" onclick="toggleEditExperience(this)" class="btn">Anuluj</button>
                </form>

            </li>
        </ul>
        <form id="experienceForm" enctype="multipart/form-data" th:if="${isOwnProfile}" class="experience-form">
            <h4>Dodaj nowe doświadczenie</h4>

            <label>Nazwa ukończonego kursu/szkoły:</label>
            <input type="text" name="graduationName" class="w3-input w3-border" required/>

            <label>Data uzyskania certyfikatu:</label>
            <input type="date" name="graduationDate" class="w3-input w3-border" required/>

            <label>Zdjęcie/PDF certyfikatu:</label>
            <input type="file" id="certificationFile" name="certificationFile" class="w3-input w3-border" accept="image/*,.pdf" required onchange="previewCertificate(event)"/>

            <!-- Podgląd załadowanego obrazu -->
            <div class="img-preview-container" id="imgPreviewContainer">
                <img class="img-preview" id="imgPreview" alt="Podgląd zdjęcia"/>
                <button type="button" class="remove-img-btn" onclick="removeSelectedFile()">✖</button>
            </div>

            <button type="submit" class="btn">Dodaj doświadczenie</button>
        </form>

    </div>
    <!-- Lightbox dla powiększania zdjęć -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <img id="lightbox-img" class="lightbox-content" />
    </div>
</div> <!-- end .container -->

<div th:replace="~{footer :: footer}"></div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    function validateForm(event, form) {
        console.log("Walidacja uruchomiona dla formularza:", form.id);
        let isValid = true;

        function showError(input, message) {
            input.classList.add("input-error");
            let errorMsg = document.createElement("div");
            errorMsg.className = "error-message";
            errorMsg.innerText = message;
            input.parentNode.appendChild(errorMsg);
        }

        // Czyszczenie poprzednich błędów
        form.querySelectorAll(".error-message").forEach(e => e.remove());
        form.querySelectorAll(".input-error").forEach(e => e.classList.remove("input-error"));

        if (form.id === "editStartDate") {
            let startDateInput = document.getElementById("startDateInput");
            let startDate = new Date(startDateInput.value);
            let today = new Date();
            today.setHours(0, 0, 0, 0);

            if (startDate > today) {
                showError(startDateInput, "Data rozpoczęcia kariery nie może być późniejsza niż dzisiaj.");
                isValid = false;
            }
        }

        if (form.id === "editPhoneNumber") {
            let phoneInput = document.getElementById("phoneNumberInput");
            let phoneRegex = /^\+?\d{9,11}$/;

            if (!phoneRegex.test(phoneInput.value)) {
                showError(phoneInput, "Numer telefonu musi mieć od 9 do 11 cyfr i może zaczynać się od '+'.");
                isValid = false;
            }
        }

        if (form.id === "editWorkArea") {
            let workAreaInput = document.getElementById("workAreaInput");

            if (workAreaInput.value.trim() === "") {
                showError(workAreaInput, "Obszar pracy jest wymagany.");
                isValid = false;
            } else if (!/^[A-ZĄĆĘŁŃÓŚŹŻ]/.test(workAreaInput.value)) {
                showError(workAreaInput, "Obszar pracy musi zaczynać się dużą literą.");
                isValid = false;
            }
        }

        if (form.id === "editBioForm") {
            let bioInput = document.getElementById("bioInput");

            if (bioInput.value.trim() === "") {
                showError(bioInput, "Opis jest wymagany.");
                isValid = false;
            }
        }

        if (!isValid) {
            event.preventDefault();
            console.log("Formularz nie został wysłany:", form.id);
            return false;
        }
        console.log("Formularz poprawny, wysyłka:", form.id);
        return true;
    }

    function attachValidation(formId, fieldId, inputId, urlField) {
        let form = document.getElementById(formId);
        if (form) {
            form.addEventListener("submit", function (event) {
                let isFormValid = validateForm(event, form);
                if (!isFormValid) return false;

                let input = document.getElementById(inputId);
                let value = input.value.trim();

                fetch('/trainer/profile/updateField', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `field=${urlField}&value=${encodeURIComponent(value)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById(fieldId).innerText = value !== "" ? value : "Nie podano";
                        form.style.display = "none";
                    } else {
                        alert("Błąd zapisu!");
                    }
                })
                .catch(error => console.error("Błąd AJAX:", error));

                event.preventDefault();
            });
        }
    }

    // Podpinanie walidacji do formularzy edycji
    attachValidation("editStartDate", "startDateText", "startDateInput", "startDate");
    attachValidation("editPhoneNumber", "phoneNumberText", "phoneNumberInput", "phoneNumber");
    attachValidation("editWorkArea", "workAreaText", "workAreaInput", "workArea");
    attachValidation("editBioForm", "bioText", "bioInput", "bio");
});
</script>

<script th:inline="javascript">
document.addEventListener("DOMContentLoaded", function() {
  // Funkcja pomocnicza do wyświetlania komunikatów walidacyjnych
  function showError(input, message) {
    input.classList.add("input-error");
    let errorMsg = document.createElement("div");
    errorMsg.className = "error-message";
    errorMsg.innerText = message;
    input.parentNode.appendChild(errorMsg);
  }

  // Funkcja do przełączania widoczności formularzy edycji
  window.toggleEdit = function(formId, textId) {
    let form = document.getElementById(formId);
    let text = document.getElementById(textId);
    if (!form || !text) {
      console.error("Elementy formularza nie zostały znalezione.");
      return;
    }
    if (form.style.display === "none" || form.style.display === "") {
      form.style.display = "block";
    } else {
      form.style.display = "none";
    }
  };

document.addEventListener("DOMContentLoaded", function () {
    let trainerId = [[${user.idUser}]];
    let loggedInUserId = [[${isAuthenticated} ? ${userId} : -1]];
    let isAdmin = [[${isAdmin} ? 'true' : 'false']];
    isAdmin = isAdmin === 'true';
    let currentPage = 1;
    let totalReviews = 0;
    let reviewsPerPage = 5;

    let reviewList = document.getElementById("reviewList");
    let userReviewList = document.getElementById("userReviewList");
    let averageRating = document.getElementById("averageRating");
    let reviewForm = document.getElementById("reviewForm");
    let editReviewForm = document.getElementById("editReviewForm");
    let editRating = document.getElementById("editRating");
    let editComment = document.getElementById("editComment");
    let userReviewContainer = document.getElementById("userReviewContainer");
    let editingReviewId = null;

    if (reviewForm) {
        reviewForm.addEventListener("submit", function (event) {
            event.preventDefault();

            let formData = new FormData(reviewForm);
            formData.append("trainerId", trainerId);

            fetch("/trainer/reviews/add", {
                method: "POST",
                body: new URLSearchParams(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Błąd: " + data.error);
                } else {
                    alert(data.message);
                    fetchReviews();
                    reviewForm.reset();
                }
            })
            .catch(error => console.error("Błąd dodawania opinii:", error));
        });
    }

    function fetchReviews() {
        fetch(`/trainer/reviews/${trainerId}`)
            .then(response => response.json())
            .then(data => {
                reviewList.innerHTML = "";
                userReviewList.innerHTML = "";
                if (data.length === 0) {
                    reviewList.innerHTML = "<p>Brak opinii.</p>";
                    averageRating.textContent = "Brak ocen";
                    return;
                }

                let totalRating = 0;
                let userReview = null;
                let otherReviews = [];

                data.forEach(review => {
                    totalRating += review.rating;
                    if (review.clientId === loggedInUserId) {
                        userReview = review;
                    } else {
                        otherReviews.push(review);
                    }
                });

                if (userReview) {
                    let li = createReviewElement(userReview, true);
                    userReviewList.appendChild(li);
                    userReviewContainer.style.display = "block";
                } else {
                    userReviewContainer.style.display = "none";
                }

                totalReviews = otherReviews.length;
                displayReviews(otherReviews);

                let avg = (totalRating / data.length).toFixed(1);
                averageRating.textContent = `${avg} ⭐`;
            })
            .catch(error => console.error("Błąd pobierania opinii:", error));
    }

    fetchReviews();

    function createReviewElement(review, isUserReview) {
        let li = document.createElement("li");
        li.innerHTML = `<strong>${review.clientFirstName} ${review.clientLastName}:</strong>
                        ${"⭐".repeat(review.rating)}
                        <p>${review.comment ? review.comment : "Brak komentarza"}</p>
                        <small>${new Date(review.createdAt).toLocaleDateString()}</small>`;

        if (isUserReview) {
            let editButton = document.createElement("button");
            editButton.textContent = "Edytuj";
            editButton.classList.add("btn", "btn-edit");
            editButton.onclick = function () { editReview(review); };
            li.appendChild(editButton);

            let deleteButton = document.createElement("button");
            deleteButton.textContent = "Usuń";
            deleteButton.classList.add("btn", "btn-delete");
            deleteButton.onclick = function () { deleteReview(review.id); };
            li.appendChild(deleteButton);
        } else if (isAdmin) {
            let deleteButton = document.createElement("button");
            deleteButton.textContent = "Usuń";
            deleteButton.classList.add("btn", "btn-delete");
            deleteButton.onclick = function () { deleteReview(review.id); };
            li.appendChild(deleteButton);
        }
        return li;
    }

    function displayReviews(reviews) {
        reviewList.innerHTML = "";
        let start = (currentPage - 1) * reviewsPerPage;
        let end = Math.min(start + reviewsPerPage, totalReviews);

        for (let i = start; i < end; i++) {
            let li = createReviewElement(reviews[i], false);
            reviewList.appendChild(li);
        }

        let totalPages = Math.ceil(totalReviews / reviewsPerPage);
        document.getElementById("currentPage").textContent = `${currentPage} z ${totalPages}`;
        document.getElementById("prevPage").disabled = currentPage === 1;
        document.getElementById("nextPage").disabled = currentPage >= totalPages;
    }

    window.changePage = function (direction) {
        currentPage += direction;
        fetchReviews();
    };

    window.editReview = function(review) {
        editingReviewId = review.id;
        editRating.value = review.rating;
        editComment.value = review.comment || "";
        editReviewForm.style.display = "block";
        window.scrollTo({ top: editReviewForm.offsetTop, behavior: "smooth" });
    };

    window.saveEditedReview = function() {
        if (!editingReviewId) return;

        let formData = new URLSearchParams();
        formData.append("reviewId", editingReviewId);
        formData.append("rating", editRating.value);
        formData.append("comment", editComment.value);

        fetch("/trainer/reviews/update", {
            method: "PUT",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            editReviewForm.style.display = "none";
            fetchReviews();
        })
        .catch(error => console.error("Błąd edycji opinii:", error));
    };

    window.cancelEdit = function() {
        editReviewForm.style.display = "none";
        editingReviewId = null;
    };

    window.deleteReview = function(reviewId) {
        if (!confirm("Czy na pewno chcesz usunąć tę opinię?")) return;

        fetch(`/trainer/reviews/delete/${reviewId}`, {
            method: "DELETE"
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            fetchReviews();
        })
        .catch(error => console.error("Błąd usuwania opinii:", error));
    };

    fetchReviews();
});
</script>

<script>
function toggleEdit(formId, inputId, textId) {
    let form = document.getElementById(formId);
    let input = document.getElementById(inputId);
    let text = document.getElementById(textId);

    if (!form || !input || !text) {
        console.error("Nie znaleziono elementów formularza edycji.");
        return;
    }

    if (form.style.display === "none" || form.style.display === "") {
        form.style.display = "block";
        input.value = text.innerText.trim() !== "Nie podano" ? text.innerText.trim() : "";
    } else {
        form.style.display = "none";
    }
}

function updateField(fieldId, inputId, urlField) {
    let input = document.getElementById(inputId);
    if (!input || input.classList.contains("input-error")) {
        return;
    }

    let value = input.value.trim();
    if (value === "") return;

    fetch('/trainer/profile/updateField', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `field=${urlField}&value=${encodeURIComponent(value)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById(fieldId).innerText = value !== "" ? value : "Nie podano";
            input.parentElement.style.display = "none";
        } else {
            alert("Błąd zapisu!");
        }
    })
    .catch(error => console.error("Błąd AJAX:", error));
}
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Dodajemy 'novalidate' aby wyłączyć domyślne komunikaty walidacyjne
    const specializationForm = document.getElementById("specializationForm");
    if (specializationForm) {
        specializationForm.setAttribute("novalidate", "novalidate");
    }
    const experienceForm = document.getElementById("experienceForm");
    if (experienceForm) {
        experienceForm.setAttribute("novalidate", "novalidate");
    }

    const specializationList = document.getElementById("specializationList");

    // Obsługa dodawania nowej specjalizacji z własną walidacją
    if (specializationForm) {
        specializationForm.addEventListener("submit", function (event) {
            event.preventDefault();
            const specializationInput = specializationForm.querySelector("input[name='specialization']");

            specializationInput.classList.remove("input-error");
            let errorMsg = specializationInput.parentNode.querySelector(".error-message");
            if (errorMsg) errorMsg.remove();

            if (specializationInput.value.trim() === "") {
                specializationInput.classList.add("input-error");
                errorMsg = document.createElement("div");
                errorMsg.className = "error-message";
                errorMsg.innerText = "Nazwa specjalizacji jest wymagana.";
                specializationInput.parentNode.appendChild(errorMsg);
                return;
            }

            const formData = new FormData(specializationForm);

            fetch('/trainer/profile/addSpecialization', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const newLi = document.createElement("li");
                    newLi.innerHTML = `
                        <span class="specialization-name">${data.specialization}</span>
                        <button onclick="toggleEditSpecialization(this)" class="btn btn-edit">Edytuj</button>
                        <button onclick="deleteSpecialization(${data.specializationId}, this)" class="btn btn-delete">Usuń</button>
                        <form class="edit-specialization-form w3-padding-16" style="display:none;" novalidate>
                            <input type="hidden" name="specializationId" value="${data.specializationId}">
                            <input type="text" name="specialization" class="w3-input w3-border" value="${data.specialization}" required/>
                            <button type="submit" class="w3-button w3-green w3-small">Zapisz</button>
                            <button type="button" onclick="toggleEditSpecialization(this)" class="w3-button w3-gray w3-small">Anuluj</button>
                        </form>
                    `;
                    specializationList.appendChild(newLi);
                    specializationForm.reset();
                } else {
                    alert("Błąd: Nie udało się dodać specjalizacji!");
                }
            })
            .catch(error => console.error("Błąd AJAX:", error));
        });
    }

    specializationList.addEventListener("submit", function (event) {
        if (event.target.classList.contains("edit-specialization-form")) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            fetch('/trainer/profile/updateSpecialization', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const li = form.closest("li");
                    li.querySelector(".specialization-name").textContent = data.specialization;
                    form.style.display = "none";
                } else {
                    alert("Błąd: Nie udało się edytować specjalizacji!");
                }
            })
            .catch(error => console.error("Błąd AJAX:", error));
        }
    });

    window.toggleEditSpecialization = function (button) {
        const li = button.closest("li");
        const form = li.querySelector(".edit-specialization-form");
        form.style.display = (form.style.display === "none" || form.style.display === "") ? "block" : "none";
    };

    window.deleteSpecialization = function (specializationId, button) {
        if (!confirm("Czy na pewno chcesz usunąć tą specjalizację?")) return;
        fetch('/trainer/profile/deleteSpecialization', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `specializationId=${specializationId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                button.closest("li").remove();
            } else {
                alert("Błąd: Nie udało się usunąć specjalizacji!");
            }
        })
        .catch(error => console.error("Błąd AJAX:", error));
    };
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Definicja funkcji pomocniczej showError, która wyświetla komunikat walidacyjny
    function showError(input, message) {
        input.classList.add("input-error");
        let errorMsg = document.createElement("div");
        errorMsg.className = "error-message";
        errorMsg.innerText = message;
        input.parentNode.appendChild(errorMsg);
    }

    const experienceForm = document.getElementById("experienceForm");
    const experienceList = document.getElementById("experienceList");

    // Obsługa dodawania nowego doświadczenia z walidacją certyfikatu
    if (experienceForm) {
        experienceForm.addEventListener("submit", function (event) {
            event.preventDefault();
            // Usuwanie poprzednich komunikatów błędów
            experienceForm.querySelectorAll(".error-message").forEach(e => e.remove());
            experienceForm.querySelectorAll(".input-error").forEach(e => e.classList.remove("input-error"));

            let isValid = true;
            const graduationName = experienceForm.querySelector("input[name='graduationName']");
            const graduationDate = experienceForm.querySelector("input[name='graduationDate']");
            const certificationFile = experienceForm.querySelector("input[name='certificationFile']");

            if (graduationName.value.trim() === "") {
                showError(graduationName, "Nazwa ukończonego kursu/szkoły jest wymagana.");
                isValid = false;
            }

            if (graduationDate.value === "") {
                showError(graduationDate, "Data uzyskania certyfikatu jest wymagana.");
                isValid = false;
            } else {
                let selectedDate = new Date(graduationDate.value);
                let today = new Date();
                today.setHours(0, 0, 0, 0);
                if (selectedDate > today) {
                    showError(graduationDate, "Data uzyskania certyfikatu nie może być późniejsza niż dzisiaj.");
                    isValid = false;
                }
            }

            if (certificationFile.files.length === 0) {
                showError(certificationFile, "Plik certyfikatu jest wymagany.");
                isValid = false;
            }

            if (!isValid) return;

            const formData = new FormData(experienceForm);

            fetch('/trainer/profile/addExperience', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Dodaj nowy element doświadczenia do listy (reszta Twojego kodu)
                    const newLi = document.createElement("li");
                    newLi.innerHTML = `
                        <span class="experience-name">${data.graduationName}</span>
                        (Data: <span class="experience-date">${data.graduationDate}</span>)
                        ${
                          data.certificationFile
                            ? (data.certificationFile.endsWith('.pdf')
                                 ? `<br><a href="/uploads/certifications/${data.certificationFile}" target="_blank">Otwórz certyfikat (PDF)</a>`
                                 : `<br><img src="/uploads/certifications/${data.certificationFile}" width="100" alt="Certyfikat" class="experience-cert">`
                               )
                            : ''
                        }
                        <button onclick="toggleEditExperience(this)" class="btn btn-edit">Edytuj</button>
                        <button onclick="deleteExperience(${data.experienceId}, this)" class="btn btn-delete">Usuń</button>
                        <form class="edit-experience-form w3-padding-16" style="display:none;" novalidate>
                            <input type="hidden" name="experienceId" value="${data.experienceId}">
                            <label>Nazwa kursu/szkoły:</label>
                            <input type="text" name="graduationName" class="w3-input w3-border" value="${data.graduationName}" required/>
                            <label>Data uzyskania certyfikatu:</label>
                            <input type="date" name="graduationDate" class="w3-input w3-border" value="${data.graduationDate}" required/>
                            <label>Nowy plik certyfikatu (opcjonalnie):</label>
                            <input type="file" name="certificationFile" class="w3-input w3-border"/>
                            <button type="submit" class="w3-button w3-green w3-small">Zapisz</button>
                            <button type="button" onclick="toggleEditExperience(this)" class="w3-button w3-gray w3-small">Anuluj</button>
                        </form>
                    `;
                    experienceList.appendChild(newLi);
                    experienceForm.reset();
                } else {
                    alert("Błąd: Nie udało się dodać doświadczenia!");
                }
            })
            .catch(error => console.error("Błąd AJAX:", error));
        });
    }

    experienceList.addEventListener("submit", function (event) {
        if (event.target.classList.contains("edit-experience-form")) {
            event.preventDefault();
            const form = event.target;
            // Czyszczenie poprzednich komunikatów błędów
            form.querySelectorAll(".error-message").forEach(e => e.remove());
            form.querySelectorAll(".input-error").forEach(e => e.classList.remove("input-error"));

            let isValid = true;
            const graduationName = form.querySelector("input[name='graduationName']");
            const graduationDate = form.querySelector("input[name='graduationDate']");

            if (graduationName.value.trim() === "") {
                showError(graduationName, "Nazwa ukończonego kursu/szkoły jest wymagana.");
                isValid = false;
            }
            if (graduationDate.value === "") {
                showError(graduationDate, "Data uzyskania certyfikatu jest wymagana.");
                isValid = false;
            } else {
                let selectedDate = new Date(graduationDate.value);
                let today = new Date();
                today.setHours(0, 0, 0, 0);
                if (selectedDate > today) {
                    showError(graduationDate, "Data uzyskania certyfikatu nie może być późniejsza niż dzisiaj.");
                    isValid = false;
                }
            }
            if (!isValid) return;

            const formData = new FormData(form);
            fetch('/trainer/profile/updateExperience', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const li = form.closest("li");
                    li.querySelector(".experience-name").textContent = data.graduationName;
                    li.querySelector(".experience-date").textContent = data.graduationDate;

                    if (data.certificationFile) {
                        if (data.certificationFile.endsWith('.pdf')) {
                            let link = li.querySelector(".experience-cert-link");
                            if (!link) {
                                link = document.createElement("a");
                                link.classList.add("experience-cert-link");
                                link.target = "_blank";
                                li.appendChild(link);
                            }
                            link.href = "/uploads/certifications/" + data.certificationFile;
                            link.textContent = "Otwórz certyfikat (PDF)";
                            const img = li.querySelector(".experience-cert");
                            if (img) {
                                img.remove();
                            }
                        } else {
                            let img = li.querySelector(".experience-cert");
                            if (!img) {
                                img = document.createElement("img");
                                img.classList.add("experience-cert");
                                img.width = 100;
                                li.appendChild(img);
                            }
                            img.src = "/uploads/certifications/" + data.certificationFile;
                            const link = li.querySelector(".experience-cert-link");
                            if (link) {
                                link.remove();
                            }
                        }
                    }

                    form.style.display = "none";
                } else {
                    alert("Błąd: Nie udało się edytować doświadczenia!");
                }
            })
            .catch(error => console.error("Błąd AJAX:", error));
        }
    });

    window.toggleEditExperience = function (button) {
        const li = button.closest("li");
        const form = li.querySelector(".edit-experience-form");
        form.style.display = (form.style.display === "none" || form.style.display === "") ? "block" : "none";
    };

    window.deleteExperience = function (experienceId, button) {
        if (!confirm("Czy na pewno chcesz usunąć to doświadczenie?")) return;

        fetch('/trainer/profile/deleteExperience', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `experienceId=${experienceId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const listItem = button.closest("li");
                if (listItem) listItem.remove();
            } else {
                alert("Błąd: Nie udało się usunąć doświadczenia!");
            }
        })
        .catch(error => console.error("Błąd AJAX:", error));
    };
});

  // Funkcja do podglądu wybranego pliku
  document.getElementById("certificationFile").addEventListener("change", function(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById("imgPreview").src = e.target.result;
        document.getElementById("imgPreviewContainer").style.display = "block";
      };
      reader.readAsDataURL(file);
    }
  });

  // Funkcja usuwania załączonego pliku
  function removeSelectedFile() {
    document.getElementById("certificationFile").value = "";
    document.getElementById("imgPreviewContainer").style.display = "none";
  }

function openLightbox(image) {
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById("lightbox-img");
    lightbox.style.display = "flex";
    lightboxImg.src = image.src;
}

function closeLightbox() {
    document.getElementById("lightbox").style.display = "none";
}
</script>

<script>
    function uploadProfilePicture() {
      let formData = new FormData(document.getElementById("uploadProfilePictureForm"));
      fetch('/trainer/profile/upload', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          document.querySelector(".profile-pic").src = data.profilePictureUrl;
        } else {
          alert("Błąd podczas przesyłania zdjęcia!");
        }
      })
      .catch(error => console.error("Błąd AJAX:", error));
    }
    function deleteProfilePicture() {
      fetch('/trainer/profile/deleteProfilePicture', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          document.querySelector(".profile-pic").src = data.defaultProfilePicture;
        } else {
          alert("Błąd podczas usuwania zdjęcia!");
        }
      })
      .catch(error => console.error("Błąd AJAX:", error));
    }

    function goBack() {
        window.history.back();
    }
</script>
</body>
</html>

