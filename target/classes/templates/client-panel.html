<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Panel Klienta</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f9;
    }
    h2, h3 {
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background-color: #fff;
    }
    table th, table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    table th {
      background-color: #f8f8f8;
      color: #333;
    }
    table tbody tr:nth-child(odd) {
      background-color: #f9f9f9;
    }
    button {
      background-color: #007bff;
      color: #fff;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    form {
      display: inline;
    }
    select {
      padding: 6px;
      margin-right: 10px;
    }
    .info {
      margin-bottom: 20px;
      padding: 10px;
      background-color: #eaf4fc;
      border-left: 5px solid #007bff;
    }

    /* Modal Styles */
    .modal {
      display: none; /* Hidden by default */
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      padding-top: 60px;
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
  </style>
  <script>
document.addEventListener("DOMContentLoaded", function () {
    // Logika istniejąca
    const cancelButtons = document.querySelectorAll("form button[data-confirm='true']");
    const modal = document.getElementById("myModal");
    const span = document.getElementsByClassName("close")[0];
    const confirmButton = document.getElementById("confirmCancel");

    let requestIdToCancel = null;

    cancelButtons.forEach(button => {
        button.addEventListener("click", function (event) {
            event.preventDefault();
            requestIdToCancel = button.closest("form").getAttribute("data-request-id");
            modal.style.display = "block";
        });
    });

    span.onclick = function() {
        modal.style.display = "none";
    };

    window.onclick = function(event) {
        if (event.target === modal) {
            modal.style.display = "none";
        }
    };

    confirmButton.addEventListener("click", function () {
        const form = document.querySelector(`form[data-request-id='${requestIdToCancel}']`);

        fetch(form.action, {
            method: 'POST',
        })
        .then(response => {
            if (response.ok) {
                const row = form.closest("tr");
                row.parentNode.removeChild(row);
                modal.style.display = "none";
            } else {
                console.error("Błąd przy anulowaniu zapytania");
            }
        })
        .catch(error => console.error('Błąd:', error));
    });

    // Logika nowa — obsługa formularza `sendRequest`
    const trainerSelect = document.getElementById("trainer");
    const sendButton = document.getElementById("sendRequestButton");

    function toggleSendButton() {
        if (trainerSelect.value) {
            sendButton.disabled = false;
        } else {
            sendButton.disabled = true;
        }
    }

    trainerSelect.addEventListener("change", toggleSendButton);
    toggleSendButton(); // Inicjalizacja przy starcie
});
</script>

</head>
<body>
<h2>Panel Klienta</h2>
<body>
<h2>Panel Klienta</h2>

<a href="/home" class="w3-button w3-light-grey">Powrót na stronę główną</a>
<!-- Reszta zawartości -->

<div class="info">
  <p>Witaj w swoim panelu klienta! Zarządzaj współpracą z trenerami oraz wysyłaj nowe zapytania.</p>
</div>

<h3>Twoi trenerzy:</h3>
<table>
  <thead>
  <tr>
    <th>Imię</th>
    <th>Nazwisko</th>
    <th>Akcja</th>
  </tr>
  </thead>
  <tbody>
  <tr th:each="trainer : ${clientTrainers}">
    <td th:text="${trainer.trainer.firstName}"></td>
    <td th:text="${trainer.trainer.secondName}"></td>
    <td>
      <form th:action="@{/rejectTrainer}" method="post">
        <input type="hidden" name="trainerId" th:value="${trainer.trainer.idUser}" />
        <button type="submit">Zrezygnuj ze współpracy</button>
      </form>
    </td>
  </tr>
  </tbody>
</table>

<h3>Wybierz nowego trenera:</h3>
<form th:action="@{/requests/send}" method="post" id="sendRequestForm">
  <input type="hidden" name="clientId" th:value="${clientId}" />
  <label for="trainer">Trener:</label>
  <select name="trainerId" id="trainer" required>
    <option value="" >Wybierz trenera</option>
    <option th:each="trainer : ${trainers}"
            th:value="${trainer.idUser}"
            th:text="${trainer.firstName}"
            th:disabled="${#lists.contains(currentTrainerIds, trainer.idUser)
                          || #lists.contains(pendingTrainerIds, trainer.idUser)}">
    </option>
  </select>
  <button type="submit" id="sendRequestButton" disabled>Wyślij prośbę</button>
</form>



<h3>Twoje oczekujące zapytania:</h3>
<table>
  <thead>
  <tr>
    <th>Imię trenera</th>
    <th>Data wysłania</th>
    <th>Akcja</th>
  </tr>
  </thead>
  <tbody>
  <tr th:each="request : ${requests}" th:if="${request.requestStatus.name() == 'pending'}">
    <td th:text="${request.trainer.firstName}"></td>
    <td th:text="${#dates.format(request.requestDate, 'yyyy-MM-dd HH:mm')}"></td>
    <td>
      <form th:attr="data-request-id=${request.id}" th:action="@{/requests/{id}/cancel(id=${request.id})}" method="post">
        <button type="button" data-confirm="true">Anuluj</button>
      </form>
    </td>

  </tr>
  </tbody>
</table>

<!-- Modal -->
<div id="myModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Czy na pewno chcesz anulować to zapytanie?</h3>
    <button id="confirmCancel">Tak, anuluj</button>
    <button onclick="document.getElementById('myModal').style.display='none'">Anuluj</button>
  </div>
</div>
</body>
</html>