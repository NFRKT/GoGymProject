<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>GoGym - Panel Klienta</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato|Montserrat">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: "Lato", sans-serif;
      background: rgba(159, 161, 167, 0.07);
      display: flex;
      flex-direction: column;
    }
    .container {
      position: relative;
      width: 900px;
      max-width: 95%;
      margin: 50px auto;
      padding: 20px 20px 40px 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      flex: 1;
    }
    .content {
      flex: 1;
    }
        /* Hero Section */
    .hero {
      background: url('/images/hero.jpg') no-repeat center center;
      background-size: cover;
      padding: 100px 0;
      color: white;
      position: relative;
    }
    .hero .overlay {
      background: rgba(0, 0, 0, 0.5);
      padding: 50px;
      text-align: center;
    }
    .btn-back {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #303a53;
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      text-decoration: none;
      font-size: 14px;
    }
    h2 {
      text-align: center;
      margin-top: 40px;
      margin-bottom: 20px;
    }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 500px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    .btn {
      background: #303a53;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      text-decoration: none;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    .btn-delete {
      background: #dc3545;
      color: white;
    }
    /* Responsywność */
    @media screen and (max-width: 768px) {
      .hero {
        padding: 60px 0;
      }
      .hero .overlay {
        padding: 20px;
      }
      .container {
        margin: 20px auto;
        padding: 10px;
      }
      h2 {
        font-size: 1.4em;
      }
      table {
        font-size: 12px;
        min-width: 100%;
      }
      th, td {
        padding: 8px;
      }
      .btn {
        padding: 6px 8px;
        font-size: 12px;
      }
    }
    select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-color: white;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='gray' d='M2 4l4 4 4-4z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 12px;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div th:replace="~{header :: header}"></div>
  <div class="content">
    <header class="hero">
      <div class="overlay">
        <h1 class="w3-jumbo">Panel Klienta</h1>
        <h3> Zarządzaj współpracą z trenerami oraz wysyłaj nowe zapytania</h3>
      </div>
    </header>
    <div class="container">
      <h3 style="text-align: center">Twoi trenerzy:</h3>
      <table id="trainers-table">
        <thead>
        <tr>
          <th>Imię</th>
          <th>Nazwisko</th>
          <th>Akcja</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="trainer : ${clientTrainers}" th:attr="data-trainer-id=${trainer.trainer.idUser}">
          <td th:text="${trainer.trainer.firstName}"></td>
          <td th:text="${trainer.trainer.secondName}"></td>
          <td>
            <form th:action="@{/rejectTrainer}" method="post" class="remove-trainer-form">
              <input type="hidden" name="trainerId" th:value="${trainer.trainer.idUser}" />
              <button class="btn btn-delete" type="submit">Zrezygnuj ze współpracy</button>
            </form>
          </td>
        </tr>
        </tbody>
      </table>

      <h3 style="text-align: center">Wybierz nowego trenera:</h3>
      <form th:action="@{/requests/send}" method="post" id="sendRequestForm">
        <input type="hidden" name="clientId" th:value="${clientId}" />
        <select class="w3-select" style="text-align: center" name="trainerId" id="trainer" required>
          <option value="">-- Wybierz trenera --</option>
          <option th:each="trainer : ${trainers}"
                  th:value="${trainer.idUser}"
                  th:text="${trainer.firstName}"
                  th:disabled="${#lists.contains(currentTrainerIds, trainer.idUser) || #lists.contains(pendingTrainerIds, trainer.idUser)}">
          </option>
        </select>
        <button class="btn" type="submit" id="sendRequestButton">Wyślij prośbę</button>
      </form>

      <h3 style="text-align: center">Twoje oczekujące zapytania:</h3>
      <table id="pending-requests">
        <thead>
        <tr>
          <th>Imię trenera</th>
          <th>Data wysłania</th>
          <th>Akcja</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="request : ${requests}" th:if="${request.requestStatus.name() == 'pending'}" th:attr="data-request-id=${request.id}">
          <td th:text="${request.trainer.firstName}"></td>
          <td th:text="${#dates.format(request.requestDate, 'yyyy-MM-dd HH:mm')}"></td>
          <td>
            <form class="cancel-request-form" th:action="@{/requests/{id}/cancel(id=${request.id})}" method="post">
              <input type="hidden" name="trainerId" th:value="${request.trainer.idUser}">
              <button class="btn" type="submit">Anuluj</button>
            </form>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

  </div>

<div th:replace="~{footer :: footer}"></div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
      const trainerSelect = document.getElementById("trainer");
      const sendButton = document.getElementById("sendRequestButton");
      const pendingRequestsTable = document.querySelector("#pending-requests tbody");

      function checkForUpdatedRequests() {
          fetch("/requests/client/pending")
              .then(response => response.json())
              .then(data => {
                  if (Array.isArray(data)) {
                      let existingRequestIds = Array.from(document.querySelectorAll("#pending-requests tbody tr"))
                          .map(row => row.getAttribute("data-request-id"));

                      existingRequestIds.forEach(requestId => {
                          if (!data.some(request => request.id.toString() === requestId)) {
                              let rowToRemove = document.querySelector(`#pending-requests tbody tr[data-request-id="${requestId}"]`);
                              if (rowToRemove) rowToRemove.remove();
                          }
                      });
                  }
              })
              .catch(error => console.error("Błąd sprawdzania zapytań:", error));
      }

      function checkForUpdatedTrainers() {
        fetch("/client/trainers")
          .then(response => response.json())
          .then(data => {
            let currentTrainerIds = new Set(data.map(trainer => trainer.id.toString()));
            // Usuwamy trenerów, którzy przestali być współpracującymi
            document.querySelectorAll("#trainers-table tbody tr").forEach(row => {
              let trainerId = row.getAttribute("data-trainer-id");
              if (!currentTrainerIds.has(trainerId)) row.remove();
            });
            // Dodajemy nowych trenerów (jeśli są)
            data.forEach(trainer => {
              if (!document.querySelector(`#trainers-table tbody tr[data-trainer-id="${trainer.id}"]`)) {
                let newRow = document.createElement("tr");
                newRow.setAttribute("data-trainer-id", trainer.id);
                newRow.innerHTML = `
                  <td>${trainer.firstName}</td>
                  <td>${trainer.secondName}</td>
                  <td>
                    <form action="/rejectTrainer" method="post" class="remove-trainer-form">
                      <input type="hidden" name="trainerId" value="${trainer.id}">
                      <button class="btn btn-delete" type="submit">Zrezygnuj ze współpracy</button>
                    </form>
                  </td>
                `;
                document.querySelector("#trainers-table tbody").appendChild(newRow);
                attachRemoveTrainerListener(newRow.querySelector(".remove-trainer-form"));
              }
            });
          })
          .catch(error => console.error("Błąd sprawdzania trenerów:", error));
      }

      document.getElementById("sendRequestForm").addEventListener("submit", function (event) {
          event.preventDefault();
          let formData = new FormData(this);
          let selectedTrainerId = trainerSelect.value;
          let selectedTrainerName = trainerSelect.options[trainerSelect.selectedIndex].text;

          fetch(this.action, { method: "POST", body: formData })
              .then(response => response.json())
              .then(data => {
                  if (data.requestId) {
                      let newRow = document.createElement("tr");
                      newRow.setAttribute("data-request-id", data.requestId);
                      newRow.innerHTML = `
                          <td>${selectedTrainerName}</td>
                          <td>${new Date(data.requestDate).toLocaleString()}</td>
                          <td>
                              <form class="cancel-request-form" action="/requests/${data.requestId}/cancel" method="post">
                                  <input type="hidden" name="trainerId" value="${selectedTrainerId}">
                                  <button class="btn" type="submit">Anuluj</button>
                              </form>
                          </td>
                      `;
                      pendingRequestsTable.appendChild(newRow);
                      attachCancelRequestListener(newRow.querySelector(".cancel-request-form"));

                      // Wyłącz opcję w select, ale nie blokuj przycisku
                      let option = trainerSelect.querySelector(`option[value="${selectedTrainerId}"]`);
                      if (option) option.disabled = true;

                      // Resetujemy pole wyboru trenera, ale **nie blokujemy** przycisku
                      trainerSelect.value = "";
                  }
              })
              .catch(error => console.error("Błąd wysyłania zapytania:", error));
      });

      function attachCancelRequestListener(form) {
          form.addEventListener("submit", function (event) {
              event.preventDefault();
              let trainerIdInput = form.querySelector("input[name='trainerId']");
              if (!trainerIdInput || !trainerIdInput.value) {
                  console.error("Brak pola trainerId w formularzu anulowania.");
                  return;
              }
              let trainerId = trainerIdInput.value;
              fetch(form.action, { method: "POST", body: new FormData(form) })
                  .then(response => {
                      if (response.ok) {
                          form.closest("tr").remove();

                          // Ponownie aktywuj opcję w select po anulowaniu zapytania
                          let option = trainerSelect.querySelector(`option[value="${trainerId}"]`);
                          if (option) option.disabled = false;
                      }
                  })
                  .catch(error => console.error("Błąd anulowania zapytania:", error));
          });
      }
      document.querySelectorAll(".cancel-request-form").forEach(attachCancelRequestListener);

      function attachRemoveTrainerListener(form) {
        form.addEventListener("submit", function(event) {
          event.preventDefault();
          let trainerId = form.querySelector("input[name='trainerId']").value;
          fetch(form.action, { method: "POST", body: new FormData(form) })
            .then(response => response.json())
            .then(data => { if (data.status === "success") form.closest("tr").remove(); })
            .catch(error => console.error("Błąd rezygnacji:", error));
        });
      }
      document.querySelectorAll(".remove-trainer-form").forEach(attachRemoveTrainerListener);

      setInterval(() => {
        checkForUpdatedRequests();
        checkForUpdatedTrainers();
      }, 5000);
    });
  </script>
</body>
</html>
