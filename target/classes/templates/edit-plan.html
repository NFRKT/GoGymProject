<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edycja planu treningowego</title>
</head>
<body>
<h1>Edycja planu treningowego</h1>

<form id="edit-plan-form">
    <div>
        <label for="name">Nazwa planu:</label>
        <input type="text" id="name" name="name" th:value="${plan.name}" required>
    </div>
    <div>
        <label for="description">Opis planu:</label>
        <textarea id="description" name="description" th:text="${plan.description}"></textarea>
    </div>

    <input type="hidden" id="planId" th:value="${plan.idPlan}" />

    <h2>Dni planu</h2>
    <div id="days-container">
        <div th:each="day, dayStat : ${plan.trainingPlanDays}">
            <div class="day" th:data-day-id="${day.idDay}">
                <input type="hidden" name="dayIds[]" th:value="${day.idDay}">

                <div>
                    <label for="dayType-${dayStat.index}">Typ dnia:</label>
                    <select name="dayType[]" id="dayType-${dayStat.index}">
                        <option value="training" th:selected="${day.dayType.name() == 'training'}">Trening</option>
                        <option value="rest" th:selected="${day.dayType.name() == 'rest'}">Odpoczynek</option>
                    </select>
                </div>

                <div>
                    <label for="notes-${dayStat.index}">Notatki:</label>
                    <textarea name="notes[]" id="notes-${dayStat.index}" th:text="${day.notes}"></textarea>
                </div>

                <div>
                    <h3>Ä†wiczenia dnia</h3>
                    <div class="exercises">
                        <div th:each="exercise, exerciseStat : ${day.exercises}">
                            <!-- Sprawdzenie czy `exercise.exercise` nie jest null -->
                            <div class="exercise">
                                <input type="hidden" name="planExerciseIds[${dayStat.index}][]" th:value="${exercise.idPlanExercise}">
                                <input type="hidden" name="exerciseIds[${dayStat.index}][]" th:value="${exercise.idExercise}">

                                <div>
                                    <label>Ä†wiczenie:</label>
                                    <select name="exerciseIds[${dayStat.index}][]" class="exercise-select"
                                            th:data-type="${exercise.type}" onchange="toggleExerciseFields(this)">
                                        <option th:each="e : ${exercises}"
                                                th:value="${e.idExercise}"
                                                th:selected="${e.idExercise == exercise.idExercise}"
                                                th:text="${e.name}"
                                                th:data-type="${e.type}">
                                        </option>
                                    </select>
                                </div>

                                <!-- SiÅ‚owe -->
                                <div class="strength-fields" th:style="${exercise.type == 'STRENGTH'} ? 'display:block;' : 'display:none;'">
                                    <div>
                                        <label>Serie:</label>
                                        <input type="number" name="sets[${dayStat.index}][]" th:value="${exercise.sets != null ? exercise.sets : ''}">
                                    </div>
                                    <div>
                                        <label>PowtÃ³rzenia:</label>
                                        <input type="number" name="reps[${dayStat.index}][]" th:value="${exercise.reps != null ? exercise.reps : ''}">
                                    </div>
                                    <div>
                                        <label>ObciÄ…Å¼enie (kg):</label>
                                        <input type="number" step="0.1" name="weight[${dayStat.index}][]" th:value="${exercise.weight != null ? exercise.weight : ''}">
                                    </div>
                                </div>

                                <!-- Cardio -->
                                <div class="cardio-fields" th:style="${exercise.type == 'CARDIO'} ? 'display:block;' : 'display:none;'">
                                    <div>
                                        <label>Czas trwania (mm:ss):</label>
                                        <th:block th:with="formattedDuration=${exercise.duration != null ? (exercise.duration ge 3600 ? #numbers.formatInteger(exercise.duration / 3600, 2) + ':' + #numbers.formatInteger((exercise.duration % 3600) / 60, 2) + ':' + #numbers.formatInteger(exercise.duration % 60, 2) : #numbers.formatInteger(exercise.duration / 60, 2) + ':' + #numbers.formatInteger(exercise.duration % 60, 2)) : ''}">
                                            <input type="text" name="duration[${dayStat.index}][]" pattern="([0-9]{1,2}:)?[0-5][0-9]:[0-5][0-9]" placeholder="hh:mm:ss lub mm:ss" th:value="${formattedDuration}">
                                        </th:block>


                                    </div>
                                    <div>
                                        <label>Dystans (km):</label>
                                        <input type="number" step="0.1" name="distance[${dayStat.index}][]" th:value="${exercise.distance != null ? exercise.distance : ''}">
                                    </div>
                                </div>

                                <!-- ðŸ”¥ Nowy przycisk do usuwania Ä‡wiczenia -->
                                <button type="button" class="remove-exercise" onclick="removeExercise(this)">UsuÅ„ Ä‡wiczenie</button>
                            </div>



                        </div>
                    </div>
                    <button type="button" th:onclick="|addExerciseToDay(${day.idDay})|">Dodaj Ä‡wiczenie</button>
                </div>
                <button type="button" class="remove-day" onclick="removeDay(this)">UsuÅ„ dzieÅ„</button>
            </div>
        </div>
    </div>

    <button type="button" onclick="addNewDay()">Dodaj nowy dzieÅ„</button>
    <br>

    <button type="submit">Zapisz zmiany</button>
</form>

<script th:inline="javascript">
    /*[[${exercises}]]*/ // This is the Thymeleaf expression placeholder
    let exercises = /*[[${exercises}]]*/ []; // Pobranie listy Ä‡wiczeÅ„ z Thymeleaf

// ðŸ›  Poprawiona funkcja do zmiany pÃ³l formularza
function toggleExerciseFields(select) {
    if (!select) return;

    const selectedOption = select.options[select.selectedIndex];
    if (!selectedOption) return;

    const exerciseType = selectedOption.getAttribute("data-type");
    const container = select.closest(".exercise");

    if (!container) return;

    const strengthFields = container.querySelector(".strength-fields");
    const cardioFields = container.querySelector(".cardio-fields");

    if (strengthFields && cardioFields) {
        if (exerciseType === "STRENGTH") {
            strengthFields.style.display = "block";
            cardioFields.style.display = "none";
        } else if (exerciseType === "CARDIO") {
            strengthFields.style.display = "none";
            cardioFields.style.display = "block";
        }
    }
}



    // Dodanie nowego Ä‡wiczenia do dnia
window.addExerciseToDay = function(dayId) {
    const exercisesContainer = document.querySelector(
        `#days-container .day[data-day-id="${dayId}"] .exercises`
    );

    if (!exercisesContainer) return;

    const exerciseOptions = exercises.map(e =>
        `<option value="${e.idExercise}" data-type="${e.type}">${e.name}</option>`
    ).join('');

    const newExercise = document.createElement("div");
    newExercise.classList.add("exercise");

    newExercise.innerHTML = `
        <div>
            <label>Ä†wiczenie:</label>
            <select name="exerciseIds[${dayId}][]" class="exercise-select" onchange="toggleExerciseFields(this)">
                ${exerciseOptions}
            </select>
        </div>

        <!-- SiÅ‚owe (STRENGTH) -->
        <div class="strength-fields">
            <div>
                <label>Serie:</label>
                <input type="number" name="sets[${dayId}][]" min="1">
            </div>
            <div>
                <label>PowtÃ³rzenia:</label>
                <input type="number" name="reps[${dayId}][]" min="1">
            </div>
            <div>
                <label>ObciÄ…Å¼enie (kg):</label>
                <input type="number" step="0.1" name="weight[${dayId}][]" min="0">
            </div>
        </div>

        <!-- Cardio (CARDIO) -->
        <div class="cardio-fields" style="display: none;">
            <div>
                <label>Czas trwania (mm:ss):</label>
                <input type="text" name="duration[${dayId}][]" pattern="([0-9]{1,2}:)?[0-5][0-9]:[0-5][0-9]" placeholder="hh:mm:ss lub mm:ss"  class="duration-input">
            </div>
            <div>
                <label>Dystans (km):</label>
                <input type="number" step="0.1" name="distance[${dayId}][]" min="0">
            </div>
        </div>

        <!-- ðŸ”¥ Przycisk usuniÄ™cia Ä‡wiczenia -->
        <button type="button" class="remove-exercise" onclick="removeExercise(this)">UsuÅ„ Ä‡wiczenie</button>
    `;

    exercisesContainer.appendChild(newExercise);

    // Automatyczne przeÅ‚Ä…czenie pÃ³l na podstawie domyÅ›lnie wybranego Ä‡wiczenia
    const selectElement = newExercise.querySelector(".exercise-select");
    if (selectElement) toggleExerciseFields(selectElement);
};





    // Dodanie nowego dnia do planu
window.addNewDay = function () {
    const daysContainer = document.getElementById('days-container');
    const newDayIndex = daysContainer.children.length + 1; // Unikalne ID

    const newDay = document.createElement("div");
    newDay.classList.add("day");
    newDay.setAttribute("data-day-id", `new-${newDayIndex}`); // Unikalne ID

    newDay.innerHTML = `
        <input type="hidden" name="dayIds[]" value="new-${newDayIndex}">

        <div>
            <label for="dayType-${newDayIndex}">Typ dnia:</label>
            <select name="dayType[]" id="dayType-${newDayIndex}">
                <option value="training">Trening</option>
                <option value="rest">Odpoczynek</option>
            </select>
        </div>

        <div>
            <label for="notes-${newDayIndex}">Notatki:</label>
            <textarea name="notes[]" id="notes-${newDayIndex}"></textarea>
        </div>

        <div>
            <h3>Ä†wiczenia dnia</h3>
            <div class="exercises"></div>
            <button type="button" onclick="addExerciseToDay('new-${newDayIndex}')">Dodaj Ä‡wiczenie</button>
        </div>

        <!-- ðŸ”¥ Przycisk usuwania nowego dnia -->
        <button type="button" class="remove-day" onclick="removeDay(this)">UsuÅ„ dzieÅ„</button>
    `;

    daysContainer.appendChild(newDay);
};



    // ObsÅ‚uga zapisu formularza
    document.getElementById('edit-plan-form').addEventListener('submit', function (event) {
        event.preventDefault();

        const formData = collectFormData();
        const planId = document.getElementById('planId').value;

fetch(`/trainer-plans/update/${planId}`, {
    method: 'PUT',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(formData)
})
.then(response => response.json())  // Odbieramy odpowiedÅº jako JSON
.then(data => {
    updateExerciseIdsFromResponse(data); // ðŸ”¥ Aktualizujemy ID nowo dodanych Ä‡wiczeÅ„
    alert('Zapisano zmiany!');
    location.reload(); // ðŸ”¥ PRZEÅADOWANIE STRONY PO ZAPISANIU
})
.catch(error => console.error('Error:', error));

    });


// ðŸ”¥ Konwersja "hh:mm:ss" lub "mm:ss" na sekundy
function convertDurationToSeconds(duration) {
    if (!duration || duration.trim() === "") return null;

    let parts = duration.split(":").map(Number);

    if (parts.length === 3) {
        // Format "hh:mm:ss"
        return (parts[0] * 3600) + (parts[1] * 60) + parts[2];
    } else if (parts.length === 2) {
        // Format "mm:ss"
        return (parts[0] * 60) + parts[1];
    }

    return null; // Niepoprawny format
}

// Pobranie danych do zapisu
function collectFormData() {
    const planData = {
        idPlan: document.getElementById('planId').value,
        name: document.getElementById('name').value,
        description: document.getElementById('description').value,
        trainingPlanDays: []
    };

    document.querySelectorAll('#days-container .day').forEach(dayElem => {
        const dayIdInput = dayElem.querySelector('input[name^="dayIds"]');

        if (dayIdInput && dayIdInput.dataset.toDelete === "true") {
            planData.trainingPlanDays.push({ idDay: dayIdInput.value, delete: true });
            return;
        }

        const dayId = dayElem.dataset.dayId;
        const isNewDay = dayId.startsWith('new-');

        const dayData = {
            idDay: isNewDay ? null : parseInt(dayId),
            dayType: dayElem.querySelector('select[name="dayType[]"]').value,
            notes: dayElem.querySelector('textarea[name="notes[]"]').value,
            exercises: []
        };

        dayElem.querySelectorAll('.exercise').forEach(exerciseElem => {
            const exerciseSelect = exerciseElem.querySelector('select[name^="exerciseIds"]');
            const exerciseType = exerciseSelect.options[exerciseSelect.selectedIndex].getAttribute("data-type");

            const idPlanExerciseInput = exerciseElem.querySelector('input[name^="planExerciseIds"]');

            if (idPlanExerciseInput && idPlanExerciseInput.dataset.toDelete === "true") {
                dayData.exercises.push({
                    idPlanExercise: idPlanExerciseInput.value,
                    delete: true
                });
                return;
            }

            const exerciseData = {
                idPlanExercise: idPlanExerciseInput ? idPlanExerciseInput.value : null,
                idExercise: exerciseSelect.value,
            };

            if (exerciseType === "STRENGTH") {
                exerciseData.sets = exerciseElem.querySelector('input[name^="sets"]').value;
                exerciseData.reps = exerciseElem.querySelector('input[name^="reps"]').value;
                exerciseData.weight = exerciseElem.querySelector('input[name^="weight"]').value;
            } else if (exerciseType === "CARDIO") {
                let durationInput = exerciseElem.querySelector('input[name^="duration"]');
                exerciseData.duration = convertDurationToSeconds(durationInput.value); // ðŸ”¥ Konwersja mm:ss â†’ sekundy
                exerciseData.distance = exerciseElem.querySelector('input[name^="distance"]').value;
            }

            dayData.exercises.push(exerciseData);
        });

        planData.trainingPlanDays.push(dayData);
    });

    return planData;
}






    // PrzeÅ‚Ä…czenie widocznoÅ›ci pÃ³l dla juÅ¼ istniejÄ…cych Ä‡wiczeÅ„
    document.querySelectorAll('.exercise-select').forEach(select => {
        toggleExerciseFields(select);
    });

function updateExerciseIdsFromResponse(response) {
    response.trainingPlanDays.forEach(day => {
        const dayElem = document.querySelector(`.day[data-day-id="${day.idDay}"]`);
        if (!dayElem) return;

        day.exercises.forEach(exercise => {
            const exerciseElems = Array.from(dayElem.querySelectorAll('.exercise'));
            const exerciseElem = exerciseElems.find(elem => {
                const select = elem.querySelector('select[name^="exerciseIds"]');
                return select && select.value == exercise.idExercise;
            });

            if (exerciseElem) {
                let idPlanExerciseInput = exerciseElem.querySelector('input[name^="planExerciseIds"]');
                if (!idPlanExerciseInput) {
                    idPlanExerciseInput = document.createElement("input");
                    idPlanExerciseInput.type = "hidden";
                    idPlanExerciseInput.name = `planExerciseIds[${day.idDay}][]`;
                    exerciseElem.appendChild(idPlanExerciseInput);
                }
                idPlanExerciseInput.value = exercise.idPlanExercise; // ðŸ”¥ Ustawiamy poprawne ID z bazy
            }
        });
    });
}
// ðŸ›  Funkcja do usuwania Ä‡wiczenia
function removeExercise(button) {
    const exerciseDiv = button.closest(".exercise"); // ZnajdÅº kontener Ä‡wiczenia
    if (!exerciseDiv) return;

    const inputExerciseId = exerciseDiv.querySelector('input[name^="planExerciseIds"]');

    if (inputExerciseId && inputExerciseId.value) {
        // ðŸ”¥ JeÅ›li Ä‡wiczenie ma ID (czyli istnieje w bazie), oznaczamy je do usuniÄ™cia
        inputExerciseId.dataset.toDelete = "true";
        exerciseDiv.style.display = "none"; // Ukrywamy zamiast usuwaÄ‡
    } else {
        // ðŸ”¥ JeÅ›li Ä‡wiczenie jest nowo dodane, usuwamy z DOM
        exerciseDiv.remove();
    }
}

function removeDay(button) {
    const dayDiv = button.closest(".day"); // ZnajdÅº kontener dnia
    if (!dayDiv) return;

    const inputDayId = dayDiv.querySelector('input[name^="dayIds"]');

    if (inputDayId && inputDayId.value && !inputDayId.value.startsWith("new-")) {
        // ðŸ”¥ JeÅ›li dzieÅ„ istnieje w bazie, oznaczamy go do usuniÄ™cia
        inputDayId.dataset.toDelete = "true";
        dayDiv.style.display = "none"; // Ukrywamy zamiast usuwaÄ‡
    } else {
        // ðŸ”¥ JeÅ›li dzieÅ„ jest nowo dodany, usuwamy go caÅ‚kowicie z DOM
        dayDiv.remove();
    }

    updateDayDates(); // ðŸ”¥ Przeliczamy daty pozostaÅ‚ych dni
}

// ðŸ›  Funkcja do aktualizacji dat dni
function updateDayDates() {
    const days = document.querySelectorAll('#days-container .day:not([style*="display: none"])');
    let startDate = new Date(document.querySelector("#days-container .day input[name^='dayIds']").dataset.startDate); // Pobierz pierwszÄ… datÄ™

    days.forEach((day, index) => {
        const dateInput = day.querySelector('.day-date'); // Pobierz pole daty
        const newDate = new Date(startDate);
        newDate.setDate(startDate.getDate() + index); // ðŸ”¥ Ustaw nowÄ… datÄ™ w kolejnoÅ›ci

        dateInput.value = newDate.toISOString().split('T')[0]; // Aktualizujemy pole daty
    });
}




// ðŸ›  ObsÅ‚uga zmiany Ä‡wiczenia w formularzu (dla istniejÄ…cych i nowych Ä‡wiczeÅ„)
document.addEventListener("change", function (event) {
    if (event.target.classList.contains("exercise-select")) {
        toggleExerciseFields(event.target);
    }
});

// ðŸ›  Automatyczna aktualizacja pÃ³l na starcie strony
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll('.exercise-select').forEach(select => {
        toggleExerciseFields(select);
    });
});



</script>
</body>
</html>
