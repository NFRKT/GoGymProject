<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>GoGym - Panel Trenera</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato|Montserrat">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: "Lato", sans-serif;
      display: flex;
      flex-direction: column;
    }
    .content {
      flex: 1;
    }
    /* Hero Section */
    .hero {
      background: url('/images/hero.jpg') no-repeat center center;
      background-size: cover;
      padding: 100px 0;
      color: white;
      position: relative;
    }
    .hero .overlay {
      background: rgba(0, 0, 0, 0.5);
      padding: 50px;
      text-align: center;
    }
    .container {
      position: relative;
      width: 900px;
      max-width: 95%;
      margin: 50px auto;
      padding: 20px 20px 40px 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      flex: 1;
    }
    h2, h3 {
      text-align: center;
      margin-top: 20px;
      color: #303a53;
    }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 500px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    .btn {
      background: #303a53;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      text-decoration: none;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    .btn-delete {
      background: #dc3545;
      color: white;
    }
    .btn-accept {
      background: #28a745;
      color: white;
    }
    .btn-info {
      background: #303a53;
      color: white;
    }
    /* Responsywno≈õƒá */
    @media screen and (max-width: 768px) {
      .hero {
        padding: 60px 0;
      }
      .hero .overlay {
        padding: 20px;
      }
      .container {
        margin: 20px auto;
        padding: 10px;
      }
      h2 {
        font-size: 1.4em;
      }
      table {
        font-size: 12px;
        min-width: 100%;
      }
      th, td {
        padding: 8px;
      }
      .btn {
        padding: 6px 8px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
<div th:replace="~{header :: header}"></div>

<div class="content">
  <header class="hero">
    <div class="overlay">
      <h1 class="w3-jumbo">Panel Trenera</h1>
      <h3 style="color:white;">ZarzƒÖdzaj swoimi klientami i zg≈Çoszeniami</h3>
    </div>
  </header>

  <div class="container">
    <h3>Twoi klienci:</h3>
    <table id="clients-table">
      <thead>
      <tr>
        <th>Imiƒô</th>
        <th>Nazwisko</th>
        <th>Akcja</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="client : ${trainerClients}" th:attr="data-client-id=${client.client.idUser}">
        <td th:text="${client.client.firstName}"></td>
        <td th:text="${client.client.secondName}"></td>
        <td>
          <form th:action="@{/rejectClient}" method="post" class="remove-client-form">
            <input type="hidden" name="clientId" th:value="${client.client.idUser}" />
            <button class="btn btn-delete" type="submit">Zrezygnuj ze wsp√≥≈Çpracy</button>
          </form>
          <form th:action="@{/{id}/create-plan(id=${client.client.idUser})}" method="get" target="_blank">
            <button type="submit" class="btn">Stw√≥rz plan</button>
          </form>
          <form th:action="@{/client/profile/{id}(id=${client.client.idUser})}" method="get" style="display: inline;" target="_blank">
            <button class="btn btn-info" type="submit">Poka≈º profil</button>
          </form>
        </td>
      </tr>
      </tbody>
    </table>

    <h3>Nowe zg≈Çoszenia:</h3>
    <table id="new-requests-table">
      <thead>
      <tr>
        <th>Klient</th>
        <th>Akcja</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="request : ${requests}" th:attr="data-request-id=${request.id}">
        <td th:text="${request.client.firstName+ ' ' +request.client.secondName }"></td>
        <td>
          <form th:action="@{/requests/{id}/update(id=${request.id})}" method="post" class="update-request-form">
            <input type="hidden" name="status" value="accepted">
            <button class="btn btn-accept" type="submit">Akceptuj</button>
          </form>
          <form th:action="@{/requests/{id}/update(id=${request.id})}" method="post" class="update-request-form">
            <input type="hidden" name="status" value="rejected">
            <button class="btn btn-delete" type="submit">Odrzuƒá</button>
          </form>
          <form th:action="@{/client/profile/{id}(id=${request.client.idUser})}" method="get" style="display: inline;" target="_blank">
            <button class="btn btn-info" type="submit">Poka≈º profil</button>
          </form>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<div th:replace="~{footer :: footer}"></div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const clientsTable = document.querySelector("#clients-table tbody");
    const requestsTable = document.querySelector("#new-requests-table tbody");
function confirmAction(event, message) {
    if (!confirm(message)) {
        event.preventDefault(); // ‚úÖ Anuluj akcjƒô, je≈õli u≈ºytkownik kliknie ‚ÄûAnuluj‚Äù
        return false; // ‚úÖ Dodatkowe zabezpieczenie przed wys≈Çaniem formularza
    }
    return true; // ‚úÖ Je≈õli u≈ºytkownik kliknƒÖ≈Ç "OK", pozw√≥l wys≈Çaƒá formularz
}

// ‚úÖ Dodanie event√≥w do akceptacji / odrzucenia zg≈Çoszenia
function attachUpdateRequestListener(form) {
    form.addEventListener("submit", function (event) {
        let status = new FormData(this).get("status");
        let message = status === "accepted"
            ? "Czy na pewno chcesz zaakceptowaƒá tƒô pro≈õbƒô o wsp√≥≈Çpracƒô?"
            : "Czy na pewno chcesz odrzuciƒá tƒô pro≈õbƒô o wsp√≥≈Çpracƒô?";
        if (!confirmAction(event, message)) return; // ‚úÖ Dodane zabezpieczenie
    });
}

// ‚úÖ Dodanie event√≥w do rezygnacji z klienta
function attachRemoveClientListener(form) {
    form.addEventListener("submit", function (event) {
        if (!confirmAction(event, "Czy na pewno chcesz zako≈Ñczyƒá wsp√≥≈Çpracƒô z tym klientem?")) return;
    });
}
      function checkForNewRequests() {
          fetch("/requests/new-requests")
              .then(response => response.json())
              .then(data => {
                  let existingRequestIds = new Set(
                      Array.from(document.querySelectorAll("#new-requests-table tbody tr[data-request-id]"))
                          .map(row => row.getAttribute("data-request-id"))
                  );
                  data.forEach(request => {
                      if (!existingRequestIds.has(request.id.toString())) {
                          // U≈ºywamy operatora warunkowego aby sprawdziƒá, czy request.client istnieje
                          let clientName = request.client
                              ? request.client.firstName + " " + request.client.secondName
                              : "Brak danych";

                          let newRow = document.createElement("tr");
                          newRow.setAttribute("data-request-id", request.id);
                          newRow.innerHTML = `
                              <td>${clientName}</td>
                              <td>
                                  <form action="/requests/${request.id}/update" method="post" class="update-request-form">
                                      <input type="hidden" name="status" value="accepted">
                                      <button class="btn btn-accept" type="submit">Akceptuj</button>
                                  </form>
                                  <form action="/requests/${request.id}/update" method="post" class="update-request-form">
                                      <input type="hidden" name="status" value="rejected">
                                      <button class="btn btn-delete" type="submit">Odrzuƒá</button>
                                  </form>
                                  <form action="/client/profile/${request.client ? request.client.idUser : ''}" method="get" style="display: inline;" target="_blank">
                                      <button class="btn btn-info" type="submit">Poka≈º profil</button>
                                  </form>
                              </td>
                          `;
                          document.querySelector("#new-requests-table tbody").appendChild(newRow);
                          // Przypinamy eventy do formularzy
                          attachUpdateRequestListener(newRow.querySelectorAll(".update-request-form")[0]);
                          attachUpdateRequestListener(newRow.querySelectorAll(".update-request-form")[1]);
                      }
                  });
              })
              .catch(error => console.error("B≈ÇƒÖd sprawdzania nowych zg≈Çosze≈Ñ:", error));
      }

    // ‚úÖ Sprawdzanie i usuwanie anulowanych zg≈Çosze≈Ñ
    function checkForRemovedRequests() {
        fetch("/requests/new-requests")
            .then(response => response.json())
            .then(data => {
                let activeRequestIds = new Set(data.map(request => request.id.toString()));

                document.querySelectorAll("#new-requests-table tbody tr").forEach(row => {
                    let requestId = row.getAttribute("data-request-id");
                    if (!activeRequestIds.has(requestId)) {
                        row.remove(); // üîπ Usuwa wiersz, je≈õli zg≈Çoszenie zosta≈Ço anulowane
                    }
                });
            })
            .catch(error => console.error("B≈ÇƒÖd sprawdzania usuniƒôtych zg≈Çosze≈Ñ:", error));
    }

function checkForRemovedClients() {
    fetch("/trainer/clients")
        .then(response => response.json())
        .then(data => {
            console.log("üì° Odpowied≈∫ API:", data); // ‚úÖ LOG: co zwraca API

            // üîπ Sprawdzamy, czy `data` to poprawna tablica
            if (!Array.isArray(data) || data.length === 0) {
                console.warn("‚ö†Ô∏è Brak poprawnych klient√≥w w odpowiedzi API.");
                return;
            }

            // üîπ Sprawdzamy, czy dane zawierajƒÖ poprawne ID u≈ºytkownika
            let validClients = data.filter(client => client.id && client.firstName && client.secondName);

            if (validClients.length === 0) {
                console.warn("‚ö†Ô∏è Brak poprawnych klient√≥w po filtracji.");
                return;
            }

            let currentClientIds = new Set(validClients.map(client => client.id.toString()));

            // üîπ Usuwamy klient√≥w, kt√≥rych nie ma w nowej li≈õcie
            document.querySelectorAll("#clients-table tbody tr").forEach(row => {
                let clientId = row.getAttribute("data-client-id");
                if (!currentClientIds.has(clientId)) {
                    console.log(`üóëÔ∏è Usuwanie klienta o ID: ${clientId}`);
                    row.remove();
                }
            });

            // üîπ Dodajemy nowych klient√≥w do tabeli
            validClients.forEach(client => {
                let clientId = client.id.toString();
                if (!document.querySelector(`#clients-table tbody tr[data-client-id="${clientId}"]`)) {
                    console.log(`‚ûï Dodawanie klienta: ${client.firstName} ${client.secondName}`);

                    let newRow = document.createElement("tr");
                    newRow.setAttribute("data-client-id", clientId);
                    newRow.innerHTML = `
                        <td>${client.firstName}</td>
                        <td>${client.secondName}</td>
                        <td>
                            <form action="/rejectClient" method="post" class="remove-client-form">
                                <input type="hidden" name="clientId" value="${clientId}">
                                <button class="btn btn-delete" type="submit">Zrezygnuj ze wsp√≥≈Çpracy</button>
                            </form>
                            <form action="/${clientId}/create-plan" method="get" target="_blank">
                              <button type="submit" class="btn">Stw√≥rz plan</button>
                            </form>
                            <form action="/client/profile/${clientId}" method="get" target="_blank">
                              <button class="btn btn-info" type="submit">Poka≈º profil</button>
                            </form>
                        </td>
                    `;
                    document.querySelector("#clients-table tbody").appendChild(newRow);
                    attachRemoveClientListener(newRow.querySelector(".remove-client-form"));
                }
            });

        })
        .catch(error => console.error("üö® B≈ÇƒÖd pobierania klient√≥w:", error));
}


    // ‚úÖ Dodanie event√≥w do istniejƒÖcych formularzy
function attachUpdateRequestListener(form) {
    form.addEventListener("submit", function (event) {
        event.preventDefault();

        let formData = new FormData(this);
        let status = formData.get("status");

        fetch(this.action, { method: "POST", body: formData })
            .then(response => response.json())
            .then(data => {
                if (status === "accepted" && data.id && data.firstName && data.secondName) {
                    let newRow = document.createElement("tr");
                    newRow.setAttribute("data-client-id", data.id);
                    newRow.innerHTML = `
                        <td>${data.firstName}</td>
                        <td>${data.secondName}</td>
                        <td>
                            <form action="/rejectClient" method="post" class="remove-client-form">
                                <input type="hidden" name="clientId" value="${data.id}">
                                <button class="btn btn-delete" type="submit">Zrezygnuj ze wsp√≥≈Çpracy</button>
                            </form>
                            <form action="/${data.id}/create-plan" method="get" target="_blank">
                              <button type="submit" class="btn">Stw√≥rz plan</button>
                            </form>
                            <form action="/client/profile/${data.id}" method="get" target="_blank">
                              <button class="btn btn-info" type="submit">Poka≈º profil</button>
                            </form>
                        </td>
                    `;
                    clientsTable.appendChild(newRow);
                    attachRemoveClientListener(newRow.querySelector(".remove-client-form"));
                }

                form.closest("tr").remove();
            })
            .catch(error => console.error("B≈ÇƒÖd:", error));
    });
}


    function attachRemoveClientListener(form) {
        form.addEventListener("submit", function (event) {
            event.preventDefault();
            let clientId = form.querySelector("input[name='clientId']").value;

            fetch(form.action, { method: "POST", body: new FormData(form) })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        form.closest("tr").remove();
                    }
                })
                .catch(error => console.error("B≈ÇƒÖd rezygnacji:", error));
        });
    }

    document.querySelectorAll(".update-request-form").forEach(attachUpdateRequestListener);
    document.querySelectorAll(".remove-client-form").forEach(attachRemoveClientListener);

    // üîÑ Od≈õwie≈ºanie listy zg≈Çosze≈Ñ i usuwanie anulowanych co 5 sekund
    setInterval(() => {
        checkForNewRequests();
        checkForRemovedRequests();
        checkForRemovedClients();
    }, 5000);
});
</script>
</body>
</html>
